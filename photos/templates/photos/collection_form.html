{% extends 'base.html' %}
{% load static %}
{% load collection_filters %}

{% block title %}
    {% if collection %}Edit Collection{% else %}Create Collection{% endif %} - Shuttrly
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/photo_upload.css' %}">
<style>
    .form-section {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .form-section h3 {
        color: #495057;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .tag-preview {
        margin-top: 0.5rem;
    }
    
    .tag-preview .tag {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.9rem;
        margin-right: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .collaborator-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
    }
    
    .collaborator-item input[type="checkbox"] {
        margin-right: 0.5rem;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    {% if collection %}
                        Edit Collection: {{ collection.name }}
                    {% else %}
                        Create New Collection
                    {% endif %}
                </h1>
                <a href="{% url 'photos:collection_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Collections
                </a>
            </div>

            <form method="post" id="collection-form">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Basic Information</h3>
                    
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            Collection Name <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Description
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="help-text">Optional description for your collection</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.collection_type.id_for_label }}" class="form-label">
                            Collection Type
                        </label>
                        {{ form.collection_type }}
                        {% if form.collection_type.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.collection_type.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Tags -->
                <div class="form-section">
                    <h3><i class="fas fa-tags"></i> Tags</h3>
                    
                    <div class="mb-3">
                        <label for="{{ form.tags.id_for_label }}" class="form-label">
                            Tags
                        </label>
                        {{ form.tags }}
                        {% if form.tags.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.tags.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="help-text">Enter tags with # symbol, separated by spaces (e.g., #nature #travel)</div>
                        
                        <div class="tag-preview" id="tag-preview" style="display: none;">
                            <strong>Preview:</strong>
                            <div id="tag-list"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy & Sharing -->
                <div class="form-section">
                    <h3><i class="fas fa-shield-alt"></i> Privacy & Sharing</h3>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_public }}
                            <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                                Make this collection public
                            </label>
                        </div>
                        <div class="help-text">Public collections can be viewed by anyone</div>
                    </div>
                    
                    {% if users %}
                        <div class="mb-3">
                            <label class="form-label">Collaborators</label>
                            <div class="help-text">Select users who can contribute to this collection</div>
                            
                            <div class="collaborators-list">
                                {% for user in users %}
                                    <div class="collaborator-item">
                                        <input type="checkbox" name="collaborators" value="{{ user.id }}" id="collaborator_{{ user.id }}"
                                               {% if collection and user in collection.collaborators.all %}checked{% endif %}>
                                        <label for="collaborator_{{ user.id }}" class="mb-0">
                                            {{ user.username }} ({{ user.email }})
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Form Actions -->
                <div class="d-flex justify-content-between">
                    {% if collection %}
                        <a href="{% url 'photos:collection_detail' collection.id %}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    {% else %}
                        <a href="{% url 'photos:collection_list' %}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                    {% endif %}
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        {% if collection %}Update Collection{% else %}Create Collection{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tagsInput = document.getElementById('{{ form.tags.id_for_label }}');
    const tagPreview = document.getElementById('tag-preview');
    const tagList = document.getElementById('tag-list');
    
    // Tag preview functionality
    function updateTagPreview() {
        const tags = tagsInput.value.trim();
        if (tags) {
            const tagArray = tags.split(/\s+/).filter(tag => tag.trim());
            const formattedTags = tagArray.map(tag => {
                const cleanTag = tag.startsWith('#') ? tag : `#${tag}`;
                return `<span class="tag">${cleanTag}</span>`;
            });
            
            tagList.innerHTML = formattedTags.join('');
            tagPreview.style.display = 'block';
        } else {
            tagPreview.style.display = 'none';
        }
    }
    
    // Update preview on input
    tagsInput.addEventListener('input', updateTagPreview);
    
    // Initial preview
    updateTagPreview();
    
    // Form validation
    const form = document.getElementById('collection-form');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('{{ form.name.id_for_label }}').value.trim();
        
        if (!name) {
            e.preventDefault();
            alert('Please enter a collection name.');
            return false;
        }
    });
});
</script>
{% endblock %}
