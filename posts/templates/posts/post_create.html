{% extends "base.html" %}
{% load static %}

{% block title %}Create Post - Shuttrly{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}">
<link rel="stylesheet" href="{% static 'css/post-create.css' %}">
{% endblock %}

{% block content %}
<div class="posts-container">
    <!-- Posts Header -->
    <div class="posts-header">
        <div class="container">
            <h1>Create New Post</h1>
            <p class="subtitle">Share your photos and collections with the world</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Post Type Selection Card -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-layer-group"></i> Choose Post Type</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="post-type-option {% if post_type == 'single_photo' %}active{% endif %}" 
                             data-type="single_photo"
                             hx-get="{% url 'posts:post_create' %}?type=single_photo"
                             hx-target="#post-content-area"
                             hx-push-url="true"
                             hx-swap="innerHTML"
                             hx-indicator="#loading-indicator">
                            <div class="post-type-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h6>Single Photo</h6>
                            <p class="text-muted">Share one amazing photo</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="post-type-option {% if post_type == 'multiple_photos' %}active{% endif %}" 
                             data-type="multiple_photos"
                             hx-get="{% url 'posts:post_create' %}?type=multiple_photos"
                             hx-target="#post-content-area"
                             hx-push-url="true"
                             hx-swap="innerHTML"
                             hx-indicator="#loading-indicator">
                            <div class="post-type-icon">
                                <i class="fas fa-images"></i>
                            </div>
                            <h6>Multiple Photos</h6>
                            <p class="text-muted">Share a series of photos</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="post-type-option {% if post_type == 'collection' %}active{% endif %}" 
                             data-type="collection"
                             hx-get="{% url 'posts:post_create' %}?type=collection"
                             hx-target="#post-content-area"
                             hx-push-url="true"
                             hx-swap="innerHTML"
                             hx-indicator="#loading-indicator">
                            <div class="post-type-icon">
                                <i class="fas fa-folder"></i>
                            </div>
                            <h6>Collection</h6>
                            <p class="text-muted">Share an entire collection</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="loading-indicator htmx-indicator text-center py-4" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading post type...</p>
        </div>
    
        <!-- Main Content Area -->
        <div id="post-content-area">
            <div class="row g-4">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <!-- Content Selection Area -->
                        <div class="content-selection-area mb-4">
                            {% if post_type == 'single_photo' %}
                                <!-- Single Photo Selection -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-camera"></i> Select Photo</h5>
                                    </div>
                                    <div class="card-body">
                                        <!-- Photo Search Bar -->
                                        <div class="photo-search-container mb-3">
                                            <input type="text" 
                                                   class="form-control photo-search-input" 
                                                   placeholder="Search photos by title, description, tags, or date..."
                                                   autocomplete="off">
                                            <div class="photo-search-results"></div>
                                        </div>
                                        
                                        <!-- Lazy Loading Photo Grid -->
                                        <div class="photo-grid" id="photo-grid-single">
                                            <div class="grid-header d-flex justify-content-between align-items-center mb-3">
                                                <span class="text-muted">{{ photos|length }} photos available</span>
                                                <div class="grid-controls">
                                                    <button class="btn btn-sm btn-outline-primary" id="load-more-photos" style="display: none;">
                                                        <i class="fas fa-plus"></i> Load More
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="photo-grid-container">
                                                <!-- Initial photos (first 12) -->
                                                {% for photo in photos|slice:":12" %}
                                                <div class="photo-item" 
                                                     data-photo-id="{{ photo.id }}"
                                                     data-description="{{ photo.description|default:'' }}"
                                                     data-tags="{{ photo.tags|default:'' }}"
                                                     data-date="{{ photo.uploaded_at|date:'M d, Y'|default:'' }}">
                                                    <img src="{{ photo.original_file.url }}" 
                                                         alt="{{ photo.title|default:'Photo' }}"
                                                         class="photo-thumbnail"
                                                         loading="lazy">
                                                    <div class="photo-overlay">
                                                        <div class="photo-info">
                                                            <small class="text-white">{{ photo.title|default:'Untitled' }}</small>
                                                        </div>
                                                    </div>
                                                    <div class="photo-checkbox">
                                                        <input type="radio" name="selected_photo" value="{{ photo.id }}" 
                                                               id="photo_{{ photo.id }}" class="form-check-input">
                                                        <label for="photo_{{ photo.id }}" class="form-check-label"></label>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="no-photos">
                                                    <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                                                    <h5>No photos found</h5>
                                                    <p class="text-muted">Upload some photos first to create a post</p>
                                                    <a href="{% url 'photos:upload' %}" class="btn btn-primary">
                                                        <i class="fas fa-upload"></i> Upload Photos
                                                    </a>
                                                </div>
                                                {% endfor %}
                                                
                                                <!-- Hidden photos for lazy loading -->
                                                {% if photos|length > 12 %}
                                                <div class="hidden-photos" style="display: none;">
                                                    {% for photo in photos|slice:"12:" %}
                                                    <div class="photo-item" 
                                                         data-photo-id="{{ photo.id }}"
                                                         data-description="{{ photo.description|default:'' }}"
                                                         data-tags="{{ photo.tags|default:'' }}"
                                                         data-date="{{ photo.uploaded_at|date:'M d, Y'|default:'' }}">
                                                        <img data-src="{{ photo.original_file.url }}" 
                                                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect width='150' height='150' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23dee2e6'%3E%3C/text%3E%3C/svg%3E"
                                                             alt="{{ photo.title|default:'Photo' }}"
                                                             class="photo-thumbnail lazy">
                                                        <div class="photo-overlay">
                                                            <div class="photo-info">
                                                                <small class="text-white">{{ photo.title|default:'Untitled' }}</small>
                                                            </div>
                                                        </div>
                                                        <div class="photo-checkbox">
                                                            <input type="radio" name="selected_photo" value="{{ photo.id }}" 
                                                                   id="photo_{{ photo.id }}" class="form-check-input">
                                                            <label for="photo_{{ photo.id }}" class="form-check-label"></label>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                            </div>
                                </div>
                            {% elif post_type == 'multiple_photos' %}
                                <!-- Multiple Photos Selection -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-images"></i> Select Photos</h5>
                                        <small class="text-muted">Choose multiple photos for your post</small>
                                    </div>
                                    <div class="card-body">
                                        <!-- Photo Search Bar -->
                                        <div class="photo-search-container mb-3">
                                            <input type="text" 
                                                   class="form-control photo-search-input" 
                                                   placeholder="Search photos by title, description, tags, or date..."
                                                   autocomplete="off">
                                            <div class="photo-search-results"></div>
                                        </div>
                                        
                                        <!-- Lazy Loading Photo Grid -->
                                        <div class="photo-grid" id="photo-grid-multiple">
                                            <div class="grid-header d-flex justify-content-between align-items-center mb-3">
                                                <span class="text-muted">{{ photos|length }} photos available</span>
                                                <div class="grid-controls">
                                                    <button class="btn btn-sm btn-outline-primary" id="select-all-photos">
                                                        <i class="fas fa-check-square"></i> Select All Visible
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary" id="clear-selection">
                                                        <i class="fas fa-times"></i> Clear
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="photo-grid-container">
                                                <!-- Initial photos (first 12) -->
                                                {% for photo in photos|slice:":12" %}
                                                <div class="photo-item" 
                                                     data-photo-id="{{ photo.id }}"
                                                     data-description="{{ photo.description|default:'' }}"
                                                     data-tags="{{ photo.tags|default:'' }}"
                                                     data-date="{{ photo.uploaded_at|date:'M d, Y'|default:'' }}">
                                                    <img src="{{ photo.original_file.url }}" 
                                                         alt="{{ photo.title|default:'Photo' }}"
                                                         class="photo-thumbnail"
                                                         loading="lazy">
                                                    <div class="photo-overlay">
                                                        <div class="photo-info">
                                                            <small class="text-white">{{ photo.title|default:'Untitled' }}</small>
                                                        </div>
                                                    </div>
                                                    <div class="photo-checkbox">
                                                        <input type="checkbox" name="selected_photos" value="{{ photo.id }}" 
                                                               id="photo_{{ photo.id }}" class="form-check-input">
                                                        <label for="photo_{{ photo.id }}" class="form-check-label"></label>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <div class="no-photos">
                                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                                    <h5>No photos found</h5>
                                                    <p class="text-muted">Upload some photos first to create a post</p>
                                                    <a href="{% url 'photos:upload' %}" class="btn btn-primary">
                                                        <i class="fas fa-upload"></i> Upload Photos
                                                    </a>
                                                </div>
                                                {% endfor %}
                                                
                                                <!-- Hidden photos for lazy loading -->
                                                {% if photos|length > 12 %}
                                                <div class="hidden-photos" style="display: none;">
                                                    {% for photo in photos|slice:"12:" %}
                                                    <div class="photo-item" 
                                                         data-photo-id="{{ photo.id }}"
                                                         data-description="{{ photo.description|default:'' }}"
                                                         data-tags="{{ photo.tags|default:'' }}"
                                                         data-date="{{ photo.uploaded_at|date:'M d, Y'|default:'' }}">
                                                        <img data-src="{{ photo.original_file.url }}" 
                                                             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect width='150' height='150' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23dee2e6'%3E%3C/text%3E%3C/svg%3E"
                                                             alt="{{ photo.title|default:'Photo' }}"
                                                             class="photo-thumbnail lazy">
                                                        <div class="photo-overlay">
                                                            <div class="photo-info">
                                                                <small class="text-white">{{ photo.title|default:'Untitled' }}</small>
                                                            </div>
                                                        </div>
                                                        <div class="photo-checkbox">
                                                            <input type="checkbox" name="selected_photos" value="{{ photo.id }}" 
                                                                   id="photo_{{ photo.id }}" class="form-check-input">
                                                            <label for="photo_{{ photo.id }}" class="form-check-label"></label>
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                            {% elif post_type == 'collection' %}
                                <!-- Collection Selection -->
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0"><i class="fas fa-folder"></i> Select Collection</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="collection-grid-container">
                                            {% for collection in collections %}
                                            <div class="collection-item" data-collection-id="{{ collection.id }}">
                                                <div class="collection-cover">
                                                    {% if collection.get_cover_photo_url %}
                                                        <img src="{{ collection.get_cover_photo_url }}" 
                                                             alt="{{ collection.name }}"
                                                             class="collection-thumbnail"
                                                             loading="lazy">
                                                    {% else %}
                                                        <div class="collection-placeholder">
                                                            <i class="fas fa-folder"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="collection-info">
                                                    <h6 class="collection-name">{{ collection.name }}</h6>
                                                    <p class="collection-description">{{ collection.description|truncatewords:10 }}</p>
                                                    <small class="text-muted">{{ collection.get_photo_count }} photos</small>
                                                </div>
                                                <div class="collection-checkbox">
                                                    <input type="radio" name="selected_collection" value="{{ collection.id }}" 
                                                           id="collection_{{ collection.id }}" class="form-check-input">
                                                    <label for="collection_{{ collection.id }}" class="form-check-label"></label>
                                                </div>
                                            </div>
                                            {% empty %}
                                            <div class="no-collections">
                                                <i class="fas fa-folder fa-3x text-muted mb-3"></i>
                                                <h5>No collections found</h5>
                                                <p class="text-muted">Create some collections first to share them</p>
                                                <a href="{% url 'photos:collection_create' %}" class="btn btn-primary">
                                                    <i class="fas fa-plus"></i> Create Collection
                                                </a>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Post Creation Form -->
                        <div class="post-creation-form mt-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0"><i class="fas fa-edit"></i> Post Details</h5>
                                </div>
                                <div class="card-body">
                                    <form method="post" id="post-create-form">
                                        {% csrf_token %}
                                        
                                        <!-- Hidden fields for selected content -->
                                        {% if post_type == 'single_photo' %}
                                            {{ form.photo_ids }}
                                        {% elif post_type == 'multiple_photos' %}
                                            {{ form.photo_ids }}
                                        {% elif post_type == 'collection' %}
                                            {{ form.collection_id }}
                                        {% endif %}
                                        
                                        <!-- Post Title -->
                                        <div class="mb-3">
                                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                                <i class="fas fa-heading"></i> Post Title (Optional)
                                            </label>
                                            {{ form.title }}
                                            {% if form.title.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.title.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Give your post a catchy title to grab attention</div>
                                        </div>
                                        
                                        <!-- Post Description -->
                                        <div class="mb-3">
                                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                                <i class="fas fa-align-left"></i> Description
                                            </label>
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.description.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">
                                                <i class="fas fa-info-circle text-info"></i> 
                                                {{ form.description.help_text }}
                                            </div>
                                        </div>
                                        
                                        <!-- Post Visibility -->
                                        <div class="mb-3">
                                            <label for="{{ form.visibility.id_for_label }}" class="form-label">
                                                <i class="fas fa-eye"></i> Visibility
                                            </label>
                                            {{ form.visibility }}
                                            {% if form.visibility.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.visibility.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Choose who can see your post</div>
                                        </div>
                                        
                                        <!-- Form Errors -->
                                        {% if form.non_field_errors %}
                                        <div class="alert alert-danger">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            {{ form.non_field_errors.0 }}
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Submit Buttons -->
                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                                <i class="fas fa-paper-plane"></i> Create Post
                                            </button>
                                            <a href="{% url 'posts:post_list' %}" class="btn btn-outline-secondary btn-lg">
                                                <i class="fas fa-times"></i> Cancel
                                            </a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
            </div>
        </div>
                    
            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="posts-sidebar">
                    <!-- Post Type Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle"></i> Post Type Info</h5>
                        </div>
                        <div class="card-body">
                            {% if post_type == 'single_photo' %}
                                <div class="text-center">
                                    <i class="fas fa-camera fa-3x text-primary mb-3"></i>
                                    <h6>Single Photo Post</h6>
                                    <p class="text-muted">Perfect for sharing your best shots. Great for storytelling and showcasing individual photos.</p>
                                </div>
                            {% elif post_type == 'multiple_photos' %}
                                <div class="text-center">
                                    <i class="fas fa-images fa-3x text-success mb-3"></i>
                                    <h6>Multiple Photos Post</h6>
                                    <p class="text-muted">Share a series of related photos. Ideal for events, trips, or photo stories.</p>
                                </div>
                            {% elif post_type == 'collection' %}
                                <div class="text-center">
                                    <i class="fas fa-folder fa-3x text-warning mb-3"></i>
                                    <h6>Collection Post</h6>
                                    <p class="text-muted">Share an entire collection of photos. Perfect for themed galleries and portfolios.</p>
                                </div>
                            {% else %}
                                <div class="text-center">
                                    <i class="fas fa-plus fa-3x text-info mb-3"></i>
                                    <h6>Choose a Post Type</h6>
                                    <p class="text-muted">Select a post type above to get started with creating your post.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Tips -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lightbulb"></i> Posting Tips</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <div class="p-2 bg-light rounded">
                                    <i class="fas fa-hashtag text-primary me-2"></i>
                                    <small>Use relevant hashtags for better discoverability</small>
                                </div>
                                <div class="p-2 bg-light rounded">
                                    <i class="fas fa-pen text-success me-2"></i>
                                    <small>Write engaging descriptions to tell your story</small>
                                </div>
                                <div class="p-2 bg-light rounded">
                                    <i class="fas fa-clock text-warning me-2"></i>
                                    <small>Post at optimal times for maximum engagement</small>
                                </div>
                                <div class="p-2 bg-light rounded">
                                    <i class="fas fa-users text-info me-2"></i>
                                    <small>Choose the right visibility for your audience</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Posts Preview -->
                    {% if user.is_authenticated %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-history"></i> Your Recent Posts</h5>
                        </div>
                        <div class="card-body">
                            {% with user.posts.all|slice:":3" as recent_posts %}
                                {% if recent_posts %}
                                    {% for post in recent_posts %}
                                    <div class="d-flex align-items-center mb-3 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                                        <div class="flex-shrink-0 me-3">
                                            {% if post.get_cover_image_url %}
                                                <img src="{{ post.get_cover_image_url }}" 
                                                     alt="Recent post" 
                                                     class="rounded" 
                                                     style="width: 50px; height: 50px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="flex-grow-1 min-w-0">
                                            <h6 class="mb-1 text-truncate">{{ post.title|default:"Untitled" }}</h6>
                                            <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted text-center">No posts yet. This will be your first one!</p>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load external JavaScript -->
<script src="{% static 'js/post-create.js' %}"></script>
<script>
// Template-specific configuration
window.currentPostType = '{{ post_type }}';
window.photoIdsFieldId = '{{ form.photo_ids.id_for_label }}';
window.collectionIdFieldId = '{{ form.collection_id.id_for_label }}';
window.descriptionFieldId = '{{ form.description.id_for_label }}';
window.titleFieldId = '{{ form.title.id_for_label }}';
</script>
{% endblock %}
