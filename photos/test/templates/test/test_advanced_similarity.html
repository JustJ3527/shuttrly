{% extends "base.html" %}
{% load static %}

{% block title %}Test Avanc√© de Similarit√©{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .photo-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .photo-preview {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 10px;
        margin: 20px auto;
        display: block;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .controls-panel {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }
    
    .controls-row {
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .control-group label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
    }
    
    .control-group input, .control-group select {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .btn-test {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s;
    }
    
    .btn-test:hover {
        transform: translateY(-2px);
    }
    
    .navigation {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    
    .nav-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        text-decoration: none;
        transition: background 0.2s;
    }
    
    .nav-btn:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    
    .nav-btn:disabled {
        background: #e9ecef;
        color: #6c757d;
        cursor: not-allowed;
    }
    
    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }
    
    .method-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 1px solid #e9ecef;
    }
    
    .method-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .method-title {
        font-size: 18px;
        font-weight: 700;
        color: #495057;
    }
    
    .method-count {
        background: #007bff;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    
    .similarity-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 10px;
        background: #f8f9fa;
        transition: background 0.2s;
    }
    
    .similarity-item:hover {
        background: #e9ecef;
    }
    
    .similarity-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
    }
    
    .similarity-info {
        flex: 1;
    }
    
    .similarity-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .similarity-scores {
        display: flex;
        gap: 15px;
        font-size: 12px;
    }
    
    .score-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .score-label {
        color: #6c757d;
        font-weight: 500;
    }
    
    .score-value {
        font-weight: 700;
        color: #495057;
    }
    
    .score-visual { color: #28a745; }
    .score-exif { color: #fd7e14; }
    .score-location { color: #ffc107; }
    .score-final { color: #dc3545; }
    
    .cache-stats {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
        border-left: 4px solid #2196f3;
    }
    
    .cache-stats h4 {
        margin: 0 0 10px 0;
        color: #1976d2;
    }
    
    .cache-stats p {
        margin: 5px 0;
        color: #424242;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #f5c6cb;
        margin: 20px 0;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    @media (max-width: 768px) {
        .controls-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .results-grid {
            grid-template-columns: 1fr;
        }
        
        .similarity-scores {
            flex-direction: column;
            gap: 5px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    {% if error %}
        <div class="error-message">
            <h3>Erreur</h3>
            <p>{{ error }}</p>
            <p>Total photos: {{ total_photos }}</p>
            <p>Photos with embeddings: {{ photos_with_embeddings }}</p>
        </div>
    {% else %}
        <!-- Photo Header -->
        <div class="photo-header">
            <h1>Test Avanc√© de Similarit√©</h1>
            <img src="{{ current_photo.thumbnail.url }}" alt="{{ current_photo.title }}" class="photo-preview">
            <h2>{{ current_photo.title }}</h2>
            <p>Photo {{ current_index }} sur {{ total_photos_with_embeddings }}</p>
        </div>
        
        <!-- Navigation -->
        <div class="navigation">
            {% if prev_photo %}
                <a href="?photo_id={{ prev_photo.id }}&threshold={{ test_params.threshold }}&limit={{ test_params.limit }}&use_cache={{ test_params.use_cache }}" class="nav-btn" id="prev-btn">‚Üê Pr√©c√©dent</a>
            {% else %}
                <span class="nav-btn" style="background: #e9ecef; color: #6c757d;">‚Üê Pr√©c√©dent</span>
            {% endif %}
            
            <input type="number" id="photo_id" name="photo_id" value="{{ current_photo.id }}" min="1" 
                   style="padding: 10px 15px; border: 2px solid #007bff; border-radius: 6px; text-align: center; font-weight: bold; font-size: 16px; width: 80px; background: #f8f9fa; color: #495057;"
                   title="Modifiez l'ID de la photo √† tester">
            
            {% if next_photo %}
                <a href="?photo_id={{ next_photo.id }}&threshold={{ test_params.threshold }}&limit={{ test_params.limit }}&use_cache={{ test_params.use_cache }}" class="nav-btn" id="next-btn">Suivant ‚Üí</a>
            {% else %}
                <span class="nav-btn" style="background: #e9ecef; color: #6c757d;">Suivant ‚Üí</span>
            {% endif %}
        </div>
        
        <!-- Controls Panel -->
        <div class="controls-panel">
            <h3>Param√®tres de Test</h3>
            <form method="get" id="test-form">
                <div class="controls-row">

                    
                    <div class="control-group">
                        <label for="threshold">Seuil de Similarit√©</label>
                        <input type="number" id="threshold" name="threshold" value="{{ test_params.threshold }}" min="0" max="1" step="0.1">
                    </div>
                    
                    <div class="control-group">
                        <label for="limit">Nombre de R√©sultats</label>
                        <input type="number" id="limit" name="limit" value="{{ test_params.limit }}" min="1" max="50">
                    </div>
                    
                    <div class="control-group">
                        <label for="use_cache">Utiliser le Cache</label>
                        <select id="use_cache" name="use_cache">
                            <option value="true" {% if test_params.use_cache %}selected{% endif %}>Oui</option>
                            <option value="false" {% if not test_params.use_cache %}selected{% endif %}>Non</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn-test">Tester</button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Cache Statistics -->
        {% if cache_stats %}
        <div class="cache-stats">
            <h4>üìä Statistiques du Cache</h4>
            <p><strong>Total:</strong> {{ cache_stats.total }} similarit√©s</p>
            <p><strong>Cosine:</strong> {{ cache_stats.cosine }} similarit√©s</p>
            <p><strong>Pearson:</strong> {{ cache_stats.pearson }} similarit√©s</p>
        </div>
        {% endif %}
        
        <!-- FAISS Statistics -->
        {% if faiss_stats %}
        <div class="cache-stats" style="background: #e8f5e8; border-left: 4px solid #28a745;">
            <h4>üöÄ Statistiques FAISS</h4>
            {% if faiss_stats.error %}
                <p style="color: #dc3545; font-weight: bold;">‚ùå Erreur: {{ faiss_stats.error }}</p>
            {% else %}
                <p><strong>Photos dans l'index:</strong> {{ faiss_stats.total_photos }}</p>
                <p><strong>Taille de l'index:</strong> {{ faiss_stats.index_size }}</p>
                <p><strong>Dimension:</strong> {{ faiss_stats.dimension }}</p>
                <p><strong>Index charg√©:</strong> {{ faiss_stats.is_loaded|yesno:"‚úÖ Oui,‚ùå Non" }}</p>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Results -->
        {% if test_results.error %}
            <div class="error-message">
                <h3>Erreur lors du test</h3>
                <p>{{ test_results.error }}</p>
            </div>
        {% else %}
            <div class="results-grid">
                {% for method_key, method_data in test_results.items %}
                    <div class="method-card">
                        <div class="method-header">
                            <div class="method-title">{{ method_data.method }}</div>
                            <div class="method-count">
                                {{ method_data.count }} r√©sultats
                                {% if method_data.time %}
                                    <span style="font-size: 12px; color:rgb(0, 0, 0); margin-left: 10px;">
                                        ({{ method_data.time|floatformat:3 }}s)
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if method_data.results %}
                            {% for result in method_data.results %}
                                <div class="similarity-item">
                                    <img src="{{ result.photo.thumbnail.url }}" alt="{{ result.photo.title }}" class="similarity-thumbnail">
                                    <div class="similarity-info">
                                        <div class="similarity-title">{{ result.photo.title }}</div>
                                        <div class="similarity-scores">
                                            <div class="score-item">
                                                <div class="score-label">Visuel</div>
                                                <div class="score-value score-visual">{{ result.visual|floatformat:3 }}</div>
                                            </div>
                                            {% if result.location is not None %}
                                            <div class="score-item">
                                                <div class="score-label">Localisation</div>
                                                <div class="score-value score-location">{{ result.location|floatformat:3 }}</div>
                                            </div>
                                            {% endif %}
                                            {% if result.exif is not None %}
                                            <div class="score-item">
                                                <div class="score-label">EXIF</div>
                                                <div class="score-value score-exif">{{ result.exif|floatformat:3 }}</div>
                                            </div>
                                            {% endif %}
                                            <div class="score-item">
                                                <div class="score-label">Final</div>
                                                <div class="score-value score-final">{{ result.final|floatformat:3 }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="text-align: center; color: #6c757d; padding: 20px;">
                                Aucun r√©sultat trouv√© avec ce seuil
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <!-- Summary -->
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
            <h3>üìà R√©sum√© des Tests</h3>
            <p><strong>Photo test√©e:</strong> {{ current_photo.title }} (ID: {{ current_photo.id }})</p>
            <p><strong>Param√®tres:</strong> Seuil {{ test_params.threshold }}, Limite {{ test_params.limit }}</p>
            <p><strong>Total photos avec embeddings:</strong> {{ photos_with_embeddings }}</p>
        </div>
    {% endif %}
</div>

<script>
// Auto-submit form when parameters change
document.getElementById('test-form').addEventListener('change', function() {
    this.submit();
});

// Add loading state
document.getElementById('test-form').addEventListener('submit', function() {
    const button = this.querySelector('.btn-test');
    button.textContent = 'Test en cours...';
    button.disabled = true;
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (e.key === 'ArrowLeft' && prevBtn) {
        e.preventDefault();
        window.location.href = prevBtn.href;
    } else if (e.key === 'ArrowRight' && nextBtn) {
        e.preventDefault();
        window.location.href = nextBtn.href;
    }
});

// Auto-submit form when photo ID changes (both inputs)
function handlePhotoIdChange() {
    // Preserve other form values
    const threshold = document.getElementById('threshold').value;
    const limit = document.getElementById('limit').value;
    const use_cache = document.getElementById('use_cache').value;
    
    // Update form action to include all parameters
    const params = new URLSearchParams();
    params.set('photo_id', this.value);
    params.set('threshold', threshold);
    params.set('limit', limit);
    params.set('use_cache', use_cache);
    
    window.location.href = '?' + params.toString();
}

// Add event listeners to both photo ID inputs
document.addEventListener('DOMContentLoaded', function() {
    const photoIdInputs = document.querySelectorAll('input[name="photo_id"]');
    photoIdInputs.forEach(input => {
        input.addEventListener('change', handlePhotoIdChange);
        input.addEventListener('blur', handlePhotoIdChange);
    });
});

// Debug info
console.log('Current photo ID:', {{ current_photo.id }});
console.log('Total photos with embeddings:', {{ total_photos_with_embeddings }});
console.log('Navigation:', {
    prev: {{ prev_photo.id|default:"null" }},
    next: {{ next_photo.id|default:"null" }}
});
</script>
{% endblock %}
