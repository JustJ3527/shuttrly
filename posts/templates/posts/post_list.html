{% extends 'base.html' %}
{% load static %}

{% block title %}All Posts{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}">
{% endblock %}

{% block content %}
<div class="posts-container">
    <!-- Header -->
    <div class="posts-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1><i class="fas fa-globe"></i> All Posts</h1>
                    <p class="subtitle">Discover amazing content from our community</p>
                </div>
                <div class="col-auto">
                    <div class="posts-actions">
                        <a href="{% url 'posts:post_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Post
                        </a>
                        <a href="{% url 'posts:user_feed' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-rss"></i> My Feed
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Main Posts -->
            <div class="col-lg-8">
                <div class="posts-content">
                    <!-- Search and Filters -->
                    <div class="search-filters mb-4">
                        <div class="card">
                            <div class="card-body">
                                <form method="get" class="row g-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" name="q" 
                                               placeholder="Search posts, tags, or descriptions..."
                                               value="{{ request.GET.q }}">
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" name="sort">
                                            <option value="recent" {% if request.GET.sort == 'recent' %}selected{% endif %}>Most Recent</option>
                                            <option value="popular" {% if request.GET.sort == 'popular' %}selected{% endif %}>Most Popular</option>
                                            <option value="trending" {% if request.GET.sort == 'trending' %}selected{% endif %}>Trending</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-search"></i> Search
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Posts Stream -->
                    <div class="posts-stream" id="posts-container">
                        {% include 'posts/partials/_post_list.html' %}
                    </div>

                    <!-- Loading Indicator -->
                    <div class="loading-indicator text-center py-4" id="loading-indicator" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading more posts...</p>
                    </div>

                    <!-- End of Posts -->
                    <div class="end-of-posts text-center py-4" id="end-of-posts" style="display: none;">
                        <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                        <h5>You've reached the end!</h5>
                        <p class="text-muted">No more posts to load.</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="posts-sidebar">
                    <!-- Trending Hashtags -->
                    <div class="trending-hashtags mb-4">
                        <h5><i class="fas fa-fire"></i> Trending Hashtags</h5>
                        <div class="hashtags-list">
                            {% for hashtag in trending_hashtags %}
                            <a href="{% url 'posts:hashtag_posts' hashtag.hashtag %}" class="hashtag-item">
                                <span class="hashtag-name">#{{ hashtag.hashtag }}</span>
                                <span class="hashtag-count">{{ hashtag.count }} posts</span>
                            </a>
                            {% empty %}
                            <p class="text-muted small">No trending hashtags yet</p>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="quick-stats mb-4">
                        <h5><i class="fas fa-chart-bar"></i> Quick Stats</h5>
                        <div class="stats-summary">
                            <div class="stat-row">
                                <span class="stat-label">Total Posts</span>
                                <span class="stat-value">{{ posts.paginator.count|default:0 }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Current Page</span>
                                <span class="stat-value">{{ current_page|default:1 }} / {{ total_pages|default:1 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewerTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" alt="" id="modalImage" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Include the shared posts SCSS file -->
<link rel="stylesheet" href="{% static 'scss/_posts.scss' %}">

<!-- JavaScript for infinite scroll and interactions -->
<script>
// Infinite Scroll Configuration
const INFINITE_SCROLL_CONFIG = {
    threshold: 0.1, // Trigger when 10% of the sentinel is visible
    rootMargin: '100px', // Start loading 100px before reaching the bottom
    pageSize: 12, // Number of posts per page
    currentPage: {{ current_page|default:1 }},
    totalPages: {{ total_pages|default:1 }},
    hasNext: {{ has_next|yesno:"true,false" }},
    isLoading: false,
    searchParams: new URLSearchParams(window.location.search)
};

// Initialize infinite scroll when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeInfiniteScroll();
    initializePostInteractions();
});

// Initialize infinite scroll functionality
function initializeInfiniteScroll() {
    if (!INFINITE_SCROLL_CONFIG.hasNext) {
        showEndOfPosts();
        return;
    }
    
    // Create intersection observer for infinite scroll
    const sentinel = createSentinelElement();
    const observer = new IntersectionObserver(handleIntersection, {
        threshold: INFINITE_SCROLL_CONFIG.threshold,
        rootMargin: INFINITE_SCROLL_CONFIG.rootMargin
    });
    
    observer.observe(sentinel);
}

// Create sentinel element for intersection observer
function createSentinelElement() {
    const sentinel = document.createElement('div');
    sentinel.id = 'infinite-scroll-sentinel';
    sentinel.style.height = '20px';
    sentinel.style.width = '100%';
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.appendChild(sentinel);
    
    return sentinel;
}

// Handle intersection with sentinel element
async function handleIntersection(entries) {
    const entry = entries[0];
    
    if (entry.isIntersecting && !INFINITE_SCROLL_CONFIG.isLoading && INFINITE_SCROLL_CONFIG.hasNext) {
        await loadMorePosts();
    }
}

// Load more posts via AJAX
async function loadMorePosts() {
    if (INFINITE_SCROLL_CONFIG.isLoading || !INFINITE_SCROLL_CONFIG.hasNext) {
        return;
    }
    
    try {
        INFINITE_SCROLL_CONFIG.isLoading = true;
        showLoadingIndicator();
        
        // Calculate next page
        const nextPage = INFINITE_SCROLL_CONFIG.currentPage + 1;
        
        // Build URL with current search parameters
        const url = new URL(window.location);
        url.searchParams.set('page', nextPage);
        
        // Add AJAX header
        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Make AJAX request
        const response = await fetch(url.toString(), { headers });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const html = await response.text();
        
        // Parse response and extract posts
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newPosts = doc.querySelectorAll('.post-item');
        
        if (newPosts.length > 0) {
            // Add new posts to container
            const postsContainer = document.getElementById('posts-container');
            const sentinel = document.getElementById('infinite-scroll-sentinel');
            
            newPosts.forEach(post => {
                postsContainer.insertBefore(post, sentinel);
            });
            
            // Update configuration
            INFINITE_SCROLL_CONFIG.currentPage = nextPage;
            INFINITE_SCROLL_CONFIG.hasNext = newPosts.length === INFINITE_SCROLL_CONFIG.pageSize;
            
            // Reinitialize interactions for new posts
            initializePostInteractions();
            
            // Update URL without page reload
            window.history.replaceState({}, '', url.toString());
            
        } else {
            INFINITE_SCROLL_CONFIG.hasNext = false;
        }
        
        // Check if we've reached the end
        if (!INFINITE_SCROLL_CONFIG.hasNext) {
            showEndOfPosts();
        }
        
    } catch (error) {
        console.error('Error loading more posts:', error);
        showError('Failed to load more posts. Please try again.');
    } finally {
        INFINITE_SCROLL_CONFIG.isLoading = false;
        hideLoadingIndicator();
    }
}

// Show loading indicator
function showLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'block';
    }
}

// Hide loading indicator
function hideLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Show end of posts message
function showEndOfPosts() {
    const endMessage = document.getElementById('end-of-posts');
    if (endMessage) {
        endMessage.style.display = 'block';
    }
}

// Show error message
function showError(message) {
    // Create temporary error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.insertBefore(errorDiv, postsContainer.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 5000);
}

// Initialize post interactions (likes, comments, etc.)
function initializePostInteractions() {
    // This function will be called for both initial posts and newly loaded posts
    // Add any post-specific JavaScript initialization here
}

// Image viewer functionality
function openImageViewer(imageSrc, imageTitle) {
    const modal = document.getElementById('imageViewerModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageViewerTitle');
    
    modalImage.src = imageSrc;
    modalTitle.textContent = imageTitle;
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Comment functionality
function focusCommentInput(postId) {
    const commentInput = document.querySelector(`[data-post-id="${postId}"] .comment-input`);
    if (commentInput) {
        commentInput.focus();
    }
}

function showReplyForm(commentId) {
    // Implementation for reply form
    console.log('Show reply form for comment:', commentId);
}

function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment?')) {
        // Implementation for comment deletion
        console.log('Delete comment:', commentId);
    }
}

// Share functionality
function sharePost(postId) {
    // Implementation for sharing posts
    console.log('Share post:', postId);
    
    if (navigator.share) {
        navigator.share({
            title: 'Check out this post!',
            url: window.location.origin + '/posts/' + postId + '/'
        });
    } else {
        // Fallback for browsers that don't support Web Share API
        const url = window.location.origin + '/posts/' + postId + '/';
        navigator.clipboard.writeText(url).then(() => {
            alert('Post URL copied to clipboard!');
        });
    }
}

// AJAX Functions for real-time interactions

// Get CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Toggle like functionality
async function toggleLike(postId, button) {
    try {
        const response = await fetch(`/posts/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: '',
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Update button state
            if (data.liked) {
                button.classList.add('liked');
                const icon = button.querySelector('i');
                const text = button.querySelector('.like-text');
                if (icon) icon.classList.add('text-danger');
                if (text) text.textContent = 'Liked';
            } else {
                button.classList.remove('liked');
                const icon = button.querySelector('i');
                const text = button.querySelector('.like-text');
                if (icon) icon.classList.remove('text-danger');
                if (text) text.textContent = 'Like';
            }
            
            // Update like count in stats
            const cardFooter = button.closest('.card-footer');
            if (cardFooter) {
                const likeCountSpan = cardFooter.querySelector('.engagement-stats .stat-item:nth-child(2) span');
                if (likeCountSpan) {
                    likeCountSpan.textContent = data.likes_count;
                }
            }
            
        } else {
            throw new Error('Failed to toggle like');
        }
    } catch (error) {
        console.error('Error toggling like:', error);
        alert('Error updating like status. Please try again.');
    }
}

// Toggle save functionality
async function toggleSave(postId, button) {
    try {
        const response = await fetch(`/posts/${postId}/save/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: '',
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Update button state
            if (data.saved) {
                button.classList.add('saved');
                button.querySelector('i').classList.add('text-warning');
                button.querySelector('.save-text').textContent = 'Saved';
            } else {
                button.classList.remove('saved');
                button.querySelector('i').classList.remove('text-warning');
                button.querySelector('.save-text').textContent = 'Save';
            }
            
            // Update save count in stats
            const cardFooter = button.closest('.card-footer');
            const saveCountSpan = cardFooter.querySelector('.engagement-stats .stat-item:nth-child(4) span');
            if (saveCountSpan) {
                saveCountSpan.textContent = data.saves_count;
            }
            
        } else {
            throw new Error('Failed to toggle save');
        }
    } catch (error) {
        console.error('Error toggling save:', error);
        alert('Error updating save status. Please try again.');
    }
}

// Submit comment functionality
async function submitComment(event, postId, form) {
    event.preventDefault();
    
    const formData = new FormData(form);
    const commentText = formData.get('content');
    
    if (!commentText.trim()) {
        alert('Please enter a comment');
        return;
    }
    
    try {
        const response = await fetch(`/posts/${postId}/comment/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: formData,
        });
        
        if (response.ok) {
            // Clear form
            form.reset();
            
            // Add new comment to the list
            const commentsList = form.closest('.comments-section').querySelector('.comments-list');
            const newComment = createCommentElement(commentText, '{{ user.username }}', 'Just now');
            commentsList.insertBefore(newComment, commentsList.firstChild);
            
            // Update comment count
            const commentCountSpan = form.closest('.post-item').querySelector('.stat-item:nth-child(3) span');
            if (commentCountSpan) {
                const currentCount = parseInt(commentCountSpan.textContent) || 0;
                commentCountSpan.textContent = currentCount + 1;
            }
            
            // Update comments header
            const commentsHeader = form.closest('.comments-section').querySelector('.comments-header h6');
            if (commentsHeader) {
                const currentText = commentsHeader.textContent;
                const newCount = parseInt(currentText.match(/\d+/)[0]) + 1;
                commentsHeader.textContent = `Comments (${newCount})`;
            }
            
        } else {
            throw new Error('Failed to add comment');
        }
    } catch (error) {
        console.error('Error adding comment:', error);
        alert('Error adding comment. Please try again.');
    }
}

// Create comment element for display
function createCommentElement(content, username, time) {
    const commentDiv = document.createElement('div');
    commentDiv.className = 'comment-item';
    commentDiv.innerHTML = `
        <div class="comment-avatar">
            <div class="comment-avatar-placeholder">
                <i class="fas fa-user"></i>
            </div>
        </div>
        <div class="comment-content">
            <div class="comment-header">
                <span class="comment-author">${username}</span>
                <small class="comment-time">${time}</small>
            </div>
            <p class="comment-text">${content}</p>
            <div class="comment-actions">
                <button class="btn btn-sm btn-link reply-btn" onclick="showReplyForm(${Date.now()})">
                    Reply
                </button>
                <button class="btn btn-sm btn-link text-danger" onclick="deleteComment(${Date.now()})">
                    Delete
                </button>
            </div>
        </div>
    `;
    return commentDiv;
}
</script>
{% endblock %}
