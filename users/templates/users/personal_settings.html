{% extends 'base.html' %}
{% load static %}
{% load users_filters datetime_tags %}
{% block title %}Personal Settings - Shuttrly{% endblock %}
{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/users.css' %}">
{% endblock %}

{% block content %}
<div class="container-bc">
    <div class="container-fluid">
        <div class="settings-container">
            <!-- Header -->
            <div class="settings-header">
                <h1><i class="fas fa-user-shield"></i> Personal Settings</h1>
                <p class="text-muted">Manage your account security, privacy, and personal information</p>
            </div>

            <!-- Settings Form -->
            <div class="settings-form">
                <form method="POST" id="personal-settings-form">
                    {% csrf_token %}
                    
                    <!-- Account Information Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-envelope"></i> Email & Account</h3>
                        
                        <div class="form-group">
                            <label for="id_email">Email Address *</label>
                            <input type="email" class="form-control" id="id_email" name="email" 
                                   value="{{ form.email.value|default:user.email }}" required>
                            {% if form.email.errors %}
                                <div class="error-message">{{ form.email.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> 
                                We'll send a verification code if you change this email address
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="id_date_of_birth">Date of Birth *</label>
                            <input type="date" class="form-control" id="id_date_of_birth" name="date_of_birth" 
                                   value="{{ form.date_of_birth.value|default:user.date_of_birth|date:'Y-m-d' }}" required>
                            {% if form.date_of_birth.errors %}
                                <div class="error-message">{{ form.date_of_birth.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-calendar"></i> 
                                You must be at least 16 years old. This information is private.
                            </small>
                        </div>
                    </div>

                    <!-- Password Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-lock"></i> Change Password</h3>
                        
                        <div class="form-group">
                            <label for="id_current_password">Current Password</label>
                            <input type="password" class="form-control" id="id_current_password" name="current_password" 
                                   placeholder="Enter your current password to change password">
                            {% if form.current_password.errors %}
                                <div class="error-message">{{ form.current_password.errors.0 }}</div>
                            {% endif %}
                            <small class="form-text text-muted">
                                <i class="fas fa-shield-alt"></i> 
                                Required only if you want to change your password
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_password1">New Password</label>
                                    <div class="password-input-wrapper">
                                        <input type="password" class="form-control" id="id_password1" name="password1" 
                                               placeholder="Enter new password">
                                        <i class="fas fa-eye password-toggle-icon" id="toggle-password1"></i>
                                    </div>
                                    {% if form.password1.errors %}
                                        <div class="error-message">{{ form.password1.errors.0 }}</div>
                                    {% endif %}
                                    <small class="form-text text-muted">
                                        <i class="fas fa-key"></i> 
                                        At least 12 characters with mixed case, numbers, and symbols
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_password2">Confirm New Password</label>
                                    <div class="password-input-wrapper">
                                        <input type="password" class="form-control" id="id_password2" name="password2" 
                                               placeholder="Confirm new password">
                                        <i class="fas fa-eye password-toggle-icon" id="toggle-password2"></i>
                                    </div>
                                    {% if form.password2.errors %}
                                        <div class="error-message">{{ form.password2.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Privacy Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-eye-slash"></i> Privacy Settings</h3>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="id_is_private" name="is_private" 
                                       {% if form.is_private.value|default:user.is_private %}checked{% endif %}>
                                <label class="form-check-label" for="id_is_private">
                                    Private Account
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-users"></i> 
                                Private accounts are only visible to approved followers
                            </small>
                        </div>
                    </div>

                    <!-- Two-Factor Authentication Section -->
                    <div class="form-section">
                        <h3><i class="fas fa-shield-alt"></i> Two-Factor Authentication (2FA)</h3>
                        <p class="text-muted">Add an extra layer of security to your account</p>

                        <!-- Email 2FA Method -->
                        <div class="twofa-method-section">
                            <div class="twofa-method-header">
                                <div class="twofa-method-info">
                                    <h4><i class="fas fa-envelope"></i> Email Verification</h4>
                                    <p class="text-muted">Receive verification codes via email when logging in from new devices</p>
                                </div>
                                <div class="twofa-status-badge">
                                    {% if email_2fa_enabled %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Active
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times-circle"></i> Inactive
                                                </span>
                                    {% endif %}
                                </div>
                            </div>

                            {% if email_2fa_enabled %}
                                <!-- Email 2FA is enabled - show disable option -->
                                <div class="twofa-enabled-state">
                                    <div class="alert alert-success">
                                        <i class="fas fa-shield-check"></i> 
                                        <strong>Email 2FA is protecting your account</strong><br>
                                        <small>You'll receive verification codes when logging in from new devices.</small>
                                    </div>
                                    
                                    <!-- Inline disable form -->
                                    <div id="disable-email-2fa-form" class="inline-2fa-form" style="display: none;">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Security Warning:</strong> Disabling Email 2FA will reduce the security of your account.
                                        </div>
                                        <form method="POST" class="verification-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="disable_email">
                                            <div class="form-group">
                                                <label for="disable_email_password">Password</label>
                                                <div class="verification-input-group">
                                                    <input type="password" class="form-control" id="disable_email_password" 
                                                           name="password" placeholder="Enter your password" required>
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="fas fa-times"></i> Disable Email 2FA
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="hideDisableEmail2FA()">
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                </div>
                                                <!-- Error message container for password validation -->
                                                <div class="error-message-container"></div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Main action button -->
                                    <div id="disable-email-2fa-button" class="main-action-button">
                                        <button type="button" class="btn btn-outline-danger" onclick="showDisableEmail2FA()">
                                            <i class="fas fa-times"></i> Disable Email 2FA
                                        </button>
                                    </div>
                                </div>
                            {% elif step == "verify_email_code" %}
                                <!-- Email 2FA verification step -->
                                <div class="twofa-setup-state">
                                    <div class="alert alert-info">
                                        <i class="fas fa-envelope-open"></i> 
                                        <strong>Verification Code Sent</strong><br>
                                        <small>We've sent a 6-digit code to your email address. Please enter it below.</small>
                                    </div>
                                    
                                    <form method="POST" class="verification-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="verify_email_code" />
                                        <div class="form-group">
                                            <label for="email_code">Verification Code</label>
                                            <div class="verification-input-group">
                                                <input type="text" class="form-control verification-code-input" 
                                                       id="email_code" name="email_code" 
                                                       placeholder="000000" maxlength="6" pattern="[0-9]{6}" required>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-check"></i> Verify & Enable
                                                </button>
                                            </div>
                                        </div>
                                    </form>

                                    <div class="verification-actions">
                                        <button type="button" class="btn btn-outline-secondary" onclick="cancelEmail2FASetup()">
                                            <i class="fas fa-times"></i> Cancel Setup
                                        </button>
                                        
                                        <div class="resend-section">
                                            {% if not can_resend %}
                                                <div class="countdown-info">
                                                    <i class="fas fa-clock"></i> 
                                                    New code available in <span id="timer" class="countdown-timer">{{ time_until_resend }}</span> seconds
                                                </div>
                                            {% else %}
                                                <form method="POST" style="display: inline;">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="resend_email_code" />
                                                    <button type="submit" class="btn btn-outline-info">
                                                        <i class="fas fa-redo"></i> Resend Code
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <!-- Email 2FA is disabled - show enable option -->
                                <div class="twofa-disabled-state">
                                    <div class="alert alert-light">
                                        <i class="fas fa-shield-alt"></i> 
                                        <strong>Email 2FA is not active</strong><br>
                                        <small>Enable it to add an extra layer of security to your account.</small>
                                    </div>
                                    
                                    <!-- Inline enable form -->
                                    <div id="enable-email-2fa-form" class="inline-2fa-form" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            <strong>How it works:</strong> You'll receive a verification code via email whenever you log in from a new device.
                                        </div>
                                        <form method="POST" class="verification-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="enable_email">
                                            <div class="form-group">
                                                <label for="enable_email_password">Password</label>
                                                <div class="verification-input-group">
                                                    <input type="password" class="form-control" id="enable_email_password" 
                                                           name="password" placeholder="Enter your password" required>
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-plus"></i> Enable Email 2FA
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="hideEnableEmail2FA()">
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                </div>
                                                <!-- Error message container for password validation -->
                                                <div class="error-message-container"></div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Main action button -->
                                    <div id="enable-email-2fa-button" class="main-action-button">
                                        <button type="button" class="btn btn-outline-success" onclick="showEnableEmail2FA()">
                                                <i class="fas fa-plus"></i> Enable Email 2FA
                                            </button>
                                    </div>
                                </div>
                            {% endif %}
                                </div>
                                
                        <!-- TOTP 2FA Method -->
                        <div class="twofa-method-section">
                            <div class="twofa-method-header">
                                <div class="twofa-method-info">
                                    <h4><i class="fas fa-mobile-alt"></i> Authenticator App</h4>
                                    <p class="text-muted">Use apps like Google Authenticator, Authy, or 2FAS for time-based codes</p>
                                </div>
                                <div class="twofa-status-badge">
                                    {% if totp_enabled %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Active
                                                </span>
                                            {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times-circle"></i> Inactive
                                                </span>
                                            {% endif %}
                                </div>
                            </div>

                            {% if totp_enabled %}
                                <!-- TOTP 2FA is enabled - show disable option -->
                                <div class="twofa-enabled-state">
                                    <div class="alert alert-success">
                                        <i class="fas fa-shield-check"></i> 
                                        <strong>Authenticator App 2FA is protecting your account</strong><br>
                                        <small>You'll need to enter a 6-digit code from your authenticator app when logging in.</small>
                                    </div>
                                    
                                    <!-- Inline disable form -->
                                    <div id="disable-totp-2fa-form" class="inline-2fa-form" style="display: none;">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>Security Warning:</strong> Disabling Authenticator App 2FA will reduce the security of your account.
                                        </div>
                                        <form method="POST" class="verification-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="disable_totp">
                                            <div class="form-group">
                                                <label for="disable_totp_password">Password</label>
                                                <input type="password" class="form-control" id="disable_totp_password" 
                                                       name="password" placeholder="Enter your password" required>
                                                <!-- Error message container for password validation -->
                                                <div class="error-message-container"></div>
                                            </div>
                                            <div class="form-group">
                                                <label for="disable_totp_code">Authenticator Code</label>
                                                <div class="verification-input-group">
                                                    <input type="text" class="form-control" id="disable_totp_code" 
                                                           name="disable_totp_code" placeholder="000000" maxlength="6" required>
                                                    <button type="submit" class="btn btn-danger">
                                                        <i class="fas fa-times"></i> Disable Authenticator App 2FA
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="hideDisableTOTP2FA()">
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                </div>
                                                <!-- Error message container for TOTP code validation -->
                                                <div class="error-message-container"></div>
                                                <small class="form-text text-muted">Enter the current 6-digit code from your authenticator app</small>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Main action button -->
                                    <div id="disable-totp-2fa-button" class="main-action-button">
                                        <button type="button" class="btn btn-outline-danger" onclick="showDisableTOTP2FA()">
                                            <i class="fas fa-times"></i> Disable Authenticator App 2FA
                                        </button>
                                    </div>
                                </div>
                            {% elif step == "verify_totp" %}
                                <!-- TOTP 2FA setup step -->
                                <div class="twofa-setup-state totp-setup">
                                    <div class="alert alert-info">
                                        <i class="fas fa-qrcode"></i> 
                                        <strong>Setup Authenticator App</strong><br>
                                        <small>Scan the QR code below with your authenticator app to complete the setup.</small>
                                    </div>
                                    
                                    <div class="totp-setup-content">
                                        <div class="qr-code-section">
                                            <img src="data:image/png;base64,{{ qr_code_url }}" alt="TOTP QR Code" class="qr-code-image">
                                            <p class="qr-code-instructions">
                                                <strong>Instructions:</strong><br>
                                                1. Open your authenticator app (Google Authenticator, Authy, 2FAS, etc.)<br>
                                                2. Scan this QR code or manually enter the setup key<br>
                                                3. Enter the 6-digit code that appears in your app
                                            </p>
                                        </div>

                                        {% if totp_uri %}
                                            <div class="totp-uri-section">
                                                <button id="copyTotpUriBtn" type="button" class="btn btn-outline-info btn-sm">
                                                    <i class="fas fa-copy"></i> Copy Setup Key
                                            </button>
                                                <input type="text" id="totpUriInput" value="{{ totp_uri }}" readonly style="position: absolute; left: -9999px;"/>
                                                <span id="copyMessage" class="copy-success-message">Setup key copied!</span>
                                            </div>
                                        {% endif %}

                                        <form method="POST" class="verification-form">
                                            {% csrf_token %}
                                            <div class="form-group">
                                                <label for="totp_code">Verification Code</label>
                                                <div class="verification-input-group">
                                                    <input type="text" class="form-control verification-code-input" 
                                                           id="totp_code" name="totp_code" 
                                                           placeholder="000000" maxlength="6" pattern="[0-9]{6}" required>
                                                    <button type="submit" name="action" value="verify_totp" class="btn btn-primary">
                                                        <i class="fas fa-check"></i> Verify & Enable
                                                    </button>
                                                </div>
                                                <small class="form-text text-muted">Enter the 6-digit code from your authenticator app</small>
                                            </div>
                                        </form>

                                        <div class="verification-actions">
                                            <button type="button" class="btn btn-outline-secondary" onclick="cancelTOTP2FASetup()">
                                                <i class="fas fa-times"></i> Cancel Setup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <!-- TOTP 2FA is disabled - show enable option -->
                                <div class="twofa-disabled-state">
                                    <div class="alert alert-light">
                                        <i class="fas fa-shield-alt"></i> 
                                        <strong>Authenticator App 2FA is not active</strong><br>
                                        <small>Enable it to use authenticator apps for enhanced security.</small>
                                    </div>
                                    
                                    <!-- Inline enable form -->
                                    <div id="enable-totp-2fa-form" class="inline-2fa-form" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i>
                                            <strong>How it works:</strong> You'll scan a QR code with your authenticator app and enter 6-digit codes when logging in.
                                        </div>
                                        <form method="POST" class="verification-form">
                                            {% csrf_token %}
                                            <input type="hidden" name="action" value="enable_totp">
                                            <div class="form-group">
                                                <label for="enable_totp_password">Password</label>
                                                <div class="verification-input-group">
                                                    <input type="password" class="form-control" id="enable_totp_password" 
                                                           name="password" placeholder="Enter your password" required>
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-plus"></i> Enable Authenticator App 2FA
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary" onclick="hideEnableTOTP2FA()">
                                                        <i class="fas fa-times"></i> Cancel
                                                    </button>
                                                </div>
                                                <!-- Error message container for password validation -->
                                                <div class="error-message-container"></div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Main action button -->
                                    <div id="enable-totp-2fa-button" class="main-action-button">
                                        <button type="button" class="btn btn-outline-success" onclick="showEnableTOTP2FA()">
                                            <i class="fas fa-plus"></i> Enable Authenticator App 2FA
                                        </button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Trusted Devices Section -->
                        <div class="trusted-devices-subsection">
                            <h4><i class="fas fa-desktop"></i> Trusted Devices</h4>
                            <p class="text-muted">Manage devices that can access your account without 2FA verification</p>

                            {% if trusted_devices %}
                                <div class="trusted-devices-list">
                                    {% for device in trusted_devices %}
                                        <div class="device-card">
                                            <div class="device-header" onclick="toggleDeviceDetails(this)">
                                                <div class="device-info">
                                                    <div class="device-name">
                                                        <i class="fas fa-{{ device.device_type|lower|default:'desktop' }}"></i>
                                                        {{ device.device_type|default:"Unknown Device" }}
                                                        {% if device.is_current_device %}
                                                            <span class="current-device-badge">Current Device</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="device-meta">
                                                        <span class="device-location">{{ device.location_display|format_location }}</span>
                                                        <span class="device-time">Last used {% local_datetime device.last_used_at %}</span>
                                                    </div>
                                                </div>
                                                <div class="device-actions">
                                                    {% if device.expires_soon %}
                                                        <span class="expiry-warning">Expires soon</span>
                                                    {% endif %}
                                                    <i class="fas fa-chevron-down toggle-icon"></i>
                                                </div>
                                            </div>
                                            <div class="device-details">
                                                <div class="device-specs">
                                                    <div class="spec-item">
                                                        <strong>Model:</strong> {{ device.device_family|default:"Unknown" }}
                                                    </div>
                                                    <div class="spec-item">
                                                        <strong>Browser:</strong> {{ device.browser_family|default:"Unknown" }} {{ device.browser_version|default:"" }}
                                                    </div>
                                                    <div class="spec-item">
                                                        <strong>OS:</strong> {{ device.os_family|default:"Unknown" }} {{ device.os_version|default:"" }}
                                                    </div>
                                                    <div class="spec-item">
                                                        <strong>IP:</strong> {{ device.ip_address|default:"Unknown" }}
                                                    </div>
                                                    {% if device.expires_at %}
                                                        <div class="spec-item">
                                                            <strong>Expires:</strong> {% local_datetime device.expires_at %}
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="device-actions-bottom">
                                                    <form method="POST" style="display: inline;">
                                                        {% csrf_token %}
                                                        <input type="hidden" name="action" value="remove_trusted_device">
                                                        <input type="hidden" name="device_id" value="{{ device.id }}">
                                                        <button type="submit" onclick="return confirm('Are you sure you want to revoke access for this device?')" 
                                                                class="btn btn-outline-danger btn-sm">
                                                            <i class="fas fa-trash"></i> Revoke Access
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="no-devices-message">
                                    <div class="alert alert-light text-center">
                                <i class="fas fa-info-circle"></i>
                                        <strong>No trusted devices</strong><br>
                                        <small>When you log in from a new device, you can choose to trust it for future logins.</small>
                                    </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Action Buttons for All Settings -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> Save All Settings
                        </button>
                        <a href="{% url 'profile' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Email Verification Modal -->
<div class="modal fade" id="emailVerificationModal" tabindex="-1" aria-labelledby="emailVerificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailVerificationModalLabel">Verify New Email</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>We've sent a verification code to <strong id="newEmailDisplay"></strong></p>
                <p>Please enter the 6-digit code to verify your new email address.</p>
                
                <div class="form-group">
                    <label for="verificationCode">Verification Code</label>
                    <input type="text" class="form-control" id="verificationCode" 
                           placeholder="000000" maxlength="6" pattern="[0-9]{6}">
                    <div id="verificationError" class="error-message" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="verifyEmailBtn">
                    <i class="fas fa-check"></i> Verify Email
                </button>
            </div>
        </div>
    </div>
</div>

<style>
  /* ================== 2FA METHOD SECTIONS ================== */
  .twofa-method-section {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    background: #f8f9fa;
    transition: all 0.3s ease;
  }

  .twofa-method-section:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #dee2e6;
  }

  .twofa-method-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #e9ecef;
  }

  .twofa-method-info h4 {
    margin: 0 0 0.25rem 0;
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .twofa-method-info p {
    margin: 0;
    color: #6c757d;
    font-size: 0.85rem;
  }

  .twofa-status-badge .badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.6rem;
    border-radius: 16px;
  }

  /* ================== 2FA STATES ================== */
  .twofa-enabled-state,
  .twofa-disabled-state,
  .twofa-setup-state {
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.75rem;
  }

  .twofa-enabled-state .alert {
    margin-bottom: 0.75rem;
    border-left: 3px solid #28a745;
    padding: 0.75rem;
  }

  .twofa-disabled-state .alert {
    margin-bottom: 0.75rem;
    border-left: 3px solid #6c757d;
    padding: 0.75rem;
  }

  .twofa-setup-state .alert {
    margin-bottom: 1rem;
    border-left: 3px solid #17a2b8;
    padding: 0.75rem;
  }

  /* ================== VERIFICATION FORMS ================== */
  .verification-form {
    margin-bottom: 1rem;
  }

  .verification-input-group {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
  }

  .verification-code-input {
    flex: 1;
    font-size: 1rem;
    text-align: center;
    letter-spacing: 0.1em;
    font-family: 'Courier New', monospace;
  }

  .verification-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .resend-section {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .countdown-info {
    color: #6c757d;
    font-size: 0.85rem;
  }

  .countdown-timer {
    font-weight: bold;
    color: #dc3545;
    font-family: 'Courier New', monospace;
  }

  /* ================== TOTP SETUP ================== */
  .totp-setup-content {
    text-align: center;
  }

  .qr-code-section {
    margin-bottom: 1.5rem;
  }

  .qr-code-image {
    max-width: 180px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.75rem;
    background: #fff;
    margin-bottom: 0.75rem;
  }

  .qr-code-instructions {
    text-align: left;
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    border-left: 3px solid #17a2b8;
    font-size: 0.85rem;
    line-height: 1.5;
  }

  .totp-uri-section {
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .copy-success-message {
    color: #28a745;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .copy-success-message.show {
    opacity: 1;
  }

  /* ================== TRUSTED DEVICES SUBSECTION ================== */
  .trusted-devices-subsection {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }

  .trusted-devices-subsection h4 {
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .trusted-devices-subsection p {
    color: #6c757d;
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }

  .trusted-devices-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .device-card {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    overflow: hidden;
    background: #fff;
    transition: all 0.3s ease;
  }

  .device-card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .device-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: #f8f9fa;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .device-header:hover {
    background: #e9ecef;
  }

  .device-info {
    flex: 1;
  }

  .device-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .current-device-badge {
    background: #28a745;
    color: white;
    padding: 0.2rem 0.4rem;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: normal;
  }

  .device-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: #6c757d;
  }

  .device-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .expiry-warning {
    color: #fd7e14;
    font-size: 0.75rem;
    font-weight: bold;
  }

  .toggle-icon {
    color: #6c757d;
    transition: transform 0.2s ease;
  }

  .device-header.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  .device-details {
    display: none;
    padding: 0.75rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
  }

  .device-specs {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .spec-item {
    font-size: 0.85rem;
    color: #495057;
  }

  .device-actions-bottom {
    text-align: right;
  }

  .no-devices-message {
    text-align: center;
    padding: 1.5rem;
  }

  /* ================== MODALS ================== */
  .modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  }

  .modal-header {
    border-bottom: 2px solid #f8f9fa;
    padding: 1.5rem 1.5rem 1rem;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    border-top: 2px solid #f8f9fa;
    padding: 1rem 1.5rem 1.5rem;
  }

  /* ================== RESPONSIVE DESIGN ================== */
  @media (max-width: 768px) {
    .twofa-method-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .verification-input-group {
      flex-direction: column;
      align-items: stretch;
    }

    .verification-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .device-meta {
      flex-direction: column;
      gap: 0.25rem;
    }

    .device-specs {
      grid-template-columns: 1fr;
    }
  }

  /* ================== ANIMATIONS ================== */
  .fade-in {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .slide-down {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from { max-height: 0; opacity: 0; }
    to { max-height: 500px; opacity: 1; }
  }

  /* ================== INTEGRATION WITH PERSONAL SETTINGS ================== */
  .form-section:last-of-type {
    margin-bottom: 2rem;
  }

  .form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 2px solid #f8f9fa;
  }

  /* ================== 2FA INLINE FORMS ================== */
  .inline-2fa-form {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
    background: #fff;
    border-radius: 6px;
    padding: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .inline-2fa-form .alert {
    margin-bottom: 1rem;
    padding: 0.75rem;
  }

  .inline-2fa-form .verification-input-group {
    flex-direction: row;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .inline-2fa-form .verification-input-group .btn {
    flex-shrink: 0;
    white-space: nowrap;
  }

  .inline-2fa-form .verification-input-group .btn-outline-secondary {
    margin-left: 0.5rem;
  }

  .inline-2fa-form .form-group {
    margin-bottom: 1rem;
  }

  .inline-2fa-form .form-group:last-child {
    margin-bottom: 0;
  }

  /* ================== MAIN ACTION BUTTONS ================== */
  .main-action-button {
    margin-top: 1rem;
    text-align: center;
  }

  .main-action-button .btn {
    min-width: 200px;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .main-action-button .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }

  .main-action-button .btn:active {
    transform: translateY(0);
  }

  /* ================== SMOOTH TRANSITIONS ================== */
  .inline-2fa-form {
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(-10px);
    max-height: 0;
    overflow: hidden;
  }

  .inline-2fa-form[style*="display: block"] {
    opacity: 1;
    transform: translateY(0);
    max-height: 500px;
  }

  .main-action-button {
    transition: all 0.3s ease;
    opacity: 1;
    transform: translateY(0);
  }

  .main-action-button[style*="display: none"] {
    opacity: 0;
    transform: translateY(10px);
  }

  /* ================== RESPONSIVE ADJUSTMENTS ================== */
  @media (max-width: 768px) {
    .main-action-button .btn {
      min-width: 100%;
      width: 100%;
    }

    .inline-2fa-form .verification-input-group {
      flex-direction: column;
      align-items: stretch;
    }

    .inline-2fa-form .verification-input-group .btn {
      width: 100%;
      margin-left: 0;
      margin-top: 0.5rem;
    }
  }

  /* ================== ERROR MESSAGE CONTAINERS ================== */
  .error-message-container {
    min-height: 1.5rem;
    margin-top: 0.25rem;
  }

  .error-message-container .field-error-message {
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .error-message-container .field-error-message i {
    font-size: 0.75rem;
  }

  .error-message-container .field-error-message.warning {
    color: #fd7e14;
  }

  /* ================== FORM VALIDATION STYLES ================== */
  .form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .form-control.is-valid {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }

  /* ================== 2FA FORM VALIDATION ================== */
  .inline-2fa-form .form-control.is-invalid {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }

  .inline-2fa-form .form-control.is-valid {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
  }
</style>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    
    <script>
        // Global variables for personal settings
        window.currentEmail = '{{ user.email }}';
    </script>
{% endblock %}
