{% load static %}
{% load message_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Shuttrly{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--Local CSS files-->
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <link rel="stylesheet" href="{% static 'css/step_validation.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <!-- Font Awesome -->
<!-- Font Awesome CSS (au lieu du kit JS) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap JavaScript Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toast styling -->
    <style>
        .toast {
            background: var(--background-default, #ffffff);
            border: 1px solid var(--text-200, #e5e7eb);
            color: var(--text-default, #111827);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .toast-header {
            background: var(--background-100, #f9fafb);
            border-bottom: 1px solid var(--text-200, #e5e7eb);
            color: var(--text-default, #111827);
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        .toast-body {
            color: var(--text-default, #111827);
        }
        
        .toast .btn-close {
            filter: var(--btn-close-filter, invert(0.5));
        }
    </style>

    {% endblock %}

</head>
<body>
  {% block extra_css%}
  {% endblock %}
    <!-- CSRF Token for AJAX requests -->
    {% csrf_token %}

    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message content -->
            </div>
        </div>
    </div>

    <!-- Navigation bar -->
    {% block navbar %}
    <nav class="navbar">
        <div class="navbar-logo-container">
        <!-- Hamburger button for mobile -->
          <button class="navbar-toggle" aria-label="Toggle navigation">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          
          <div class="gradient-text navbar-logo">Shuttrly</div>
        </div>
        <div class="navbar-menu">
          <ul>
            <li><a href="{% url "home" %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"><span>Home</span></a></li>
            <li><a href="{% url "posts:user_feed" %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"><span>Discover</span></a></li>
            <li><a href="#"><span>Search</span></a></li>
            <li><a href="{% url "photos:gallery" %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"><span>Gallery</span></a></li>
            <li><a href="{% url "photos:advanced_gallery" %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"><span>Advanced Gallery</span></a></li>
            <li><a href="{% url "photos:collection_list" %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true"><span>Collections</span></a></li>
          </ul>
        </div>
        <div class="navbar-actions">
          <ul>
            <li><a href="{% url "profile" %}"><i class="fas fa-user"></i></a></li>
            <li><a href="#" title="Settings"><i class="fas fa-cog"></i></a></li>
            <li><a href="{% url "logout" %}" title="Logout"><i class="fas fa-sign-out-alt"></i></a></li>
          </ul>
        </div>
      </nav>
      
      <!-- Mobile menu overlay -->
      <div class="mobile-menu-overlay">
        <div class="mobile-menu-content">
          <!-- Main Navigation Section -->
          <div class="mobile-menu-section">
            <h3><i class="fas fa-compass"></i> Navigation</h3>
            <ul>
              <li><a href="{% url "home" %}" hx-target="#main-content" hx-swap="innerHTML"><i class="fas fa-home"></i> <span>Home</span></a></li>
              <li><a href="#"><i class="fas fa-compass"></i> <span>Discover</span></a></li>
              <li><a href="#"><i class="fas fa-search"></i> <span>Search</span></a></li>
              <li><a href="{% url "photos:gallery" %}" hx-target="#main-content" hx-swap="innerHTML"><i class="fas fa-images"></i> <span>Gallery</span></a></li>
              <li><a href="{% url "photos:advanced_gallery" %}" hx-target="#main-content" hx-swap="innerHTML"><i class="fas fa-th-large"></i> <span>Advanced Gallery</span></a></li>
              <li><a href="{% url "photos:collection_list" %}" hx-target="#main-content" hx-swap="innerHTML"><i class="fas fa-cloud-upload-alt"></i> <span>Collections</span></a></li>
            </ul>
          </div>
          
          <!-- Collections Section -->
          <div class="mobile-menu-section">
            <h3><i class="fas fa-folder"></i> Collections</h3>
            <ul>
              <li><a href="#"><i class="fas fa-city"></i> <span>Urban</span></a></li>
              <li><a href="#"><i class="fas fa-portrait"></i> <span>Portraits</span></a></li>
              <li><a href="#"><i class="fas fa-plus"></i> <span>New Collection</span></a></li>
            </ul>
          </div>
          
          <!-- Gallery Tools Section -->
          <div class="mobile-menu-section">
            <h3><i class="fas fa-tools"></i> Gallery Tools</h3>
            <ul>
              <li><a href="#"><i class="fas fa-sort"></i> <span>Sort Photos</span></a></li>
              <li><a href="#"><i class="fas fa-filter"></i> <span>Filter</span></a></li>
              <li><a href="#"><i class="fas fa-tags"></i> <span>Tags</span></a></li>
              <li><a href="#"><i class="fas fa-share"></i> <span>Share</span></a></li>
            </ul>
          </div>
          
          <!-- Recent Section -->
          <div class="mobile-menu-section">
            <h3><i class="fas fa-clock"></i> Recent</h3>
            <ul>
              <li><a href="#"><i class="fas fa-calendar"></i> <span>This Week</span></a></li>
              <li><a href="#"><i class="fas fa-calendar-alt"></i> <span>This Month</span></a></li>
              <li><a href="#"><i class="fas fa-star"></i> <span>Favorites</span></a></li>
            </ul>
          </div>
          
          <!-- User Actions Section -->
          <div class="mobile-menu-section">
            <h3><i class="fas fa-user"></i> Account</h3>
            <ul>
              <li><a href="{% url "profile" %}"><div class="icon-container"><i class="fas fa-user"></i></div> <span>Profile</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-cog"></i></div> <span>Settings</span></a></li>
              <li><a href="{% url "logout" %}"><div class="icon-container"><i class="fas fa-sign-out-alt"></i></div> <span>Logout</span></a></li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Sidebar contextuelle selon la catégorie -->
      <aside class="sidebar-nav">
        <div class="sidebar-content">
          <div class="sidebar-section">
            <h3><i class="fas fa-folder"></i> Collections</h3>
            <ul>
              <li><a href="#"><div class="icon-container"><i class="fas fa-city"></i></div> <span>Urban</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-portrait"></i></div> <span>Portraits</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-plus"></i></div> <span>New Collection</span></a></li>
            </ul>
          </div>
          
          <div class="sidebar-section">
            <h3><i class="fas fa-tools"></i> Gallery Tools</h3>
            <ul>
              <li><a href="#"><div class="icon-container"><i class="fas fa-sort"></i></div> <span>Sort Photos</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-filter"></i></div> <span>Filter</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-tags"></i></div> <span>Tags</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-share"></i></div> <span>Share</span></a></li>
            </ul>
          </div>
          
          <div class="sidebar-section">
            <h3><i class="fas fa-clock"></i> Recent</h3>
            <ul>
              <li><a href="#"><div class="icon-container"><i class="fas fa-calendar"></i></div> <span>This Week</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-calendar-alt"></i></div> <span>This Month</span></a></li>
              <li><a href="#"><div class="icon-container"><i class="fas fa-star"></i></div> <span>Favorites</span></a></li>
            </ul>
          </div>
        </div>
      </aside>
    {% endblock %}
    
    <!-- Display messages with auto-clear functionality -->
    {% display_messages_with_auto_clear %}

    <div class="main-content" id="main-content" data-page="{% block main_page %}{% endblock %}">
        {% block content %}
        {% endblock %}
      
        <label for="theme-select">Choisir le thème:</label>
        <select id="theme-select">
          <option value="device">Device theme</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
    </div>
    
    {% block scripts %}

    <!-- Local JavaScript files -->
    <script src="{% static 'js/utils_scripts.js' %}"></script>
    <script src="{% static 'js/message_manager.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/step_validation.js' %}"></script>
    <script src="{% static 'js/script-navbar.js' %}"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>

    <!-- Global utility functions -->
    <script>
        // Global toast notification system
        window.showToast = function(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            // Check if toast elements exist
            if (!toast || !toastTitle || !toastMessage) {
                // Fallback: use console and alert if toast is not available
                console.log(`${title}: ${message}`);
                if (type === 'error') {
                    alert(`Error: ${message}`);
                } else if (type === 'success') {
                    alert(`Success: ${message}`);
                } else {
                    alert(`${title}: ${message}`);
                }
                return;
            }
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set icon based on type
            const icon = toastTitle.querySelector('i');
            if (icon) {
                icon.className = `fas me-2 ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}`;
            }
            
            // Show toast
            try {
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error('Error showing toast:', error);
                // Fallback to alert
                alert(`${title}: ${message}`);
            }
        };

        // Global AJAX error handler
        window.handleAjaxError = function(error, defaultMessage = 'An error occurred') {
            console.error('AJAX Error:', error);
            let message = defaultMessage;
            
            if (error.responseJSON && error.responseJSON.message) {
                message = error.responseJSON.message;
            } else if (error.message) {
                message = error.message;
            }
            
            window.showToast('Error', message, 'error');
        };
    </script>

    {% comment %} <script>
        function updateNavbarActive() {
          const page = document.getElementById('main-content').dataset.page;

          // Navbar desktop
          document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
          const activeLinkDesktop = document.querySelector(`.navbar a[hx-get$="${page}/"]`);
          if(activeLinkDesktop) activeLinkDesktop.classList.add('active');

          // Navbar mobile
          document.querySelectorAll('.mobile-menu-overlay a').forEach(a => a.classList.remove('active'));
          const activeLinkMobile = document.querySelector(`.mobile-menu-overlay a[hx-get$="${page}/"]`);
          if(activeLinkMobile) activeLinkMobile.classList.add('active');
        }

        // Appel initial
        updateNavbarActive();
        // Mettre à jour data-page après chaque swap HTMX
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'main-content') {
                const page = evt.detail.xhr.getResponseHeader('X-Page-Name');
                if (page) {
                    document.getElementById('main-content').dataset.page = page;
                }
            }
        });
      </script> {% endcomment %}
    {% endblock %}
</body>
<footer>
    <p>&copy; 2025 Shuttrly. All rights reserved.</p>
</footer>
{% block extra_js %}
{% endblock %}
</html>