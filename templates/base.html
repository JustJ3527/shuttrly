{% load static %}
{% load message_tags %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}Shuttrly{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!--Local CSS files-->
    <link rel="stylesheet" href="{% static 'css/messages.css' %}">
    <link rel="stylesheet" href="{% static 'css/step_validation.css' %}">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">

    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
    crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Theme management script (inline to prevent flickering) -->
    <script>
        // This inline script runs before the page is rendered to prevent theme flickering.
        (function() {
            function applyTheme(theme) {
                if (theme === 'device') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                } else {
                    document.documentElement.setAttribute('data-theme', theme || 'light');
                }
            }

            // Get the theme from localStorage, default to 'light' if not found.
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
        })();
    </script>

    <!-- Bootstrap JavaScript Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toast styling -->
    <style>
        .toast {
            background: var(--background-default, #ffffff);
            border: 1px solid var(--text-200, #e5e7eb);
            color: var(--text-default, #111827);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .toast-header {
            background: var(--background-100, #f9fafb);
            border-bottom: 1px solid var(--text-200, #e5e7eb);
            color: var(--text-default, #111827);
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        .toast-body {
            color: var(--text-default, #111827);
        }
        
        .toast .btn-close {
            filter: var(--btn-close-filter, invert(0.5));
        }
    </style>

    {% endblock %}

</head>
<body>
  {% block extra_css%}
  {% endblock %}
    <!-- CSRF Token for AJAX requests -->
    {% csrf_token %}

    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle me-2"></i>
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                <!-- Toast message content -->
            </div>
        </div>
    </div>

    <!-- Mobile Top Navbar -->
    <header class="mobile-top-navbar">
        <div class="mobile-logo">
            <a href="{% url 'home' %}">
                <img src="{% static 'media/profiles/default.jpg' %}" alt="Shuttrly Logo">
            </a>
        </div>
        <button class="mobile-menu-toggle" aria-label="Toggle Menu">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
    </header>

    <!-- Overlay for mobile menu -->
    <div class="navbar-overlay"></div>

    <div class="body-container">
        <!-- Navigation bar -->
        {% block navbar %}
        <!-- Left column - Navbar -->
        <div class="navbar">
            <div class="navbar-separator">
                <div class="navbar-fixed-top">
                    <div class="navbar-header">
                        <div class="navbar-logo">
                            <img src="{% static 'assets/logoShuttrly.png' %}" alt="Logo">
                        </div>
                        <div class="navbar-profile">
                            {% if user.is_authenticated %}
                            <div class="navbar-profile-picture">
                                <a href="{% url 'profile' %}">
                                    {% if user.profile_picture %}
                                        <img src="{{ user.profile_picture.url }}" alt="Profile Picture">
                                    {% else %}
                                        <img src="{% static 'media/profiles/default.jpg' %}" alt="Profile Picture">
                                    {% endif %}
                                </a>
                            </div>
                            <div class="navbar-profile-infos">
                                <a href="{% url 'profile' %}">
                                    <h2 class="navbar-profile-name">
                                        {% if user.first_name and user.last_name %}
                                            {{ user.first_name }} {{ user.last_name }}
                                        {% else %}
                                            {{ user.username }}
                                        {% endif %}
                                    </h2>
                                    <p class="navbar-profile-username">@{{ user.username }}</p>
                                </a>
                            </div>
                            {% else %}
                            <div class="navbar-profile-infos">
                                <a href="{% url 'login' %}">
                                    <h2 class="navbar-profile-name">Login</h2>
                                    <p class="navbar-profile-username">Connect to your account</p>
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="navbar-menu">
                        <ul class="navbar-menu-list">
                            <li class="navbar-menu-item">
                                <a href="{% url 'home' %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
                                    <i class="menu-icon fas fa-home"></i>
                                    <span>Home</span>
                                </a>
                            </li>
                            <li class="navbar-menu-item">
                                <a href="{% url 'posts:user_feed' %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
                                    <i class="menu-icon fas fa-compass"></i>
                                    <span>Discover</span>
                                </a>
                            </li>
                            <li class="navbar-menu-item">
                                <a href="#" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
                                    <i class="menu-icon fas fa-search"></i>
                                    <span>Search</span>
                                </a>
                            </li>
                            <li class="navbar-menu-item">
                                <a href="{% url 'photos:advanced_gallery' %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
                                    <i class="menu-icon fas fa-images"></i>
                                    <span>Gallery</span>
                                </a>
                            </li>
                            <li class="navbar-menu-item">
                                <a href="{% url 'photos:collection_list' %}" hx-target="#main-content" hx-swap="innerHTML" hx-push-url="true">
                                    <i class="menu-icon fas fa-folder"></i>
                                    <span>Collections</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="navbar-fixed-bottom">
                    <div class="navbar-actions">
                        <ul class="navbar-actions-list">
                            <li class="navbar-action-item">
                                <a href="#" title="Settings">
                                    <i class="fas fa-cog"></i>
                                </a>
                            </li>
                            {% if user.is_authenticated %}
                            <li class="navbar-action-item">
                                <a class="danger" href="{% url 'logout' %}" title="Logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                </a>
                            </li>
                            {% else %}
                            <li class="navbar-action-item">
                                <a href="{% url 'login' %}" title="Login">
                                    <i class="fas fa-sign-in-alt"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        {% endblock %}
        
        <!-- Center column - Main content -->
        <div class="main-content" id="main-content" data-page="{% block main_page %}{% endblock %}">
            {% block content %}
            {% endblock %}
            
            <!-- Theme selector -->
            <div class="theme-selector">
                <label for="theme-select">Choisir le thème:</label>
                <select id="theme-select">
                    <option value="device">Device theme</option>
                    <option value="light">Light</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>
        
        <!-- Right column - Sidebar -->
        <div class="sidebar">
            <div class="sidebar-content" id="sidebar-content">
                {% block sidebar_content %}
                <!-- User Recommendations Section -->
                {% if user.is_authenticated %}
                <div class="recommendations-section">
                    <div class="recommendations-header">
                        <h5 class="recommendations-title">Suggested Users</h5>
                        <button class="refresh-btn" onclick="refreshRecommendations()" title="Refresh recommendations">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    
                    {% include 'partials/recommendations_list.html' %}
                </div>

                <!-- Loading state (hidden by default) -->
                <div class="recommendations-loading" id="recommendations-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Calculating recommendations...</p>
                </div>
                {% else %}
                <p>Please log in to see recommendations</p>
                {% endif %}
                {% endblock %}
            </div>
        </div>
    </div>
    
    <!-- Display messages with auto-clear functionality -->
    {% display_messages_with_auto_clear %}
    
    {% block scripts %}

    <!-- Local JavaScript files -->
    <script src="{% static 'js/utils_scripts.js' %}"></script>
    <script src="{% static 'js/message_manager.js' %}"></script>
    <script src="{% static 'js/navbar.js' %}"></script>
    <script src="{% static 'js/step_validation.js' %}"></script>
    <script src="{% static 'js/script-navbar.js' %}"></script>
    <script src="{% static 'js/recommendations.js' %}"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>

    <!-- Global utility functions -->
    <script>
        // Global toast notification system
        window.showToast = function(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            
            // Check if toast elements exist
            if (!toast || !toastTitle || !toastMessage) {
                // Fallback: use console and alert if toast is not available
                console.log(`${title}: ${message}`);
                if (type === 'error') {
                    alert(`Error: ${message}`);
                } else if (type === 'success') {
                    alert(`Success: ${message}`);
                } else {
                    alert(`${title}: ${message}`);
                }
                return;
            }
            
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            // Set icon based on type
            const icon = toastTitle.querySelector('i');
            if (icon) {
                icon.className = `fas me-2 ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}`;
            }
            
            // Show toast
            try {
                const bsToast = new bootstrap.Toast(toast);
                bsToast.show();
            } catch (error) {
                console.error('Error showing toast:', error);
                // Fallback to alert
                alert(`${title}: ${message}`);
            }
        };

        // Global AJAX error handler
        window.handleAjaxError = function(error, defaultMessage = 'An error occurred') {
            console.error('AJAX Error:', error);
            let message = defaultMessage;
            
            if (error.responseJSON && error.responseJSON.message) {
                message = error.responseJSON.message;
            } else if (error.message) {
                message = error.message;
            }
            
            window.showToast('Error', message, 'error');
        };
        // Update navbar active states
        function updateNavbarActive() {
            const page = document.getElementById('main-content').dataset.page;
            const currentUrl = window.location.pathname;
            
            // Remove active class from all menu items
            document.querySelectorAll('.navbar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class based on current page
            if (page) {
                const activeItem = document.querySelector(`.navbar-menu-item a[href*="${page}"]`);
                if (activeItem) {
                    activeItem.closest('.navbar-menu-item').classList.add('active');
                }
            }
            
            // Fallback: check URL patterns for better active state management
            if (currentUrl.includes('gallery') || currentUrl.includes('gallery')) {
                const galleryItem = document.querySelector('.navbar-menu-item a[href*="gallery"]');
                if (galleryItem) {
                    galleryItem.closest('.navbar-menu-item').classList.add('active');
                }
            } else if (currentUrl.includes('collections')) {
                const collectionItem = document.querySelector('.navbar-menu-item a[href*="collections"]');
                if (collectionItem) {
                    collectionItem.closest('.navbar-menu-item').classList.add('active');
                }
            } else if (currentUrl.includes('posts') || currentUrl.includes('create')) {
                const createItem = document.querySelector('.navbar-menu-item a[href*="posts"]');
                if (createItem) {
                    createItem.closest('.navbar-menu-item').classList.add('active');
                }
            } else if (currentUrl.includes('search')) {
                const searchItem = document.querySelector('.navbar-menu-item a[href*="search"]');
                if (searchItem) {
                    searchItem.closest('.navbar-menu-item').classList.add('active');
                }
            } else if (currentUrl === '/' || currentUrl.includes('home')) {
                const homeItem = document.querySelector('.navbar-menu-item a[href*="home"]');
                if (homeItem) {
                    homeItem.closest('.navbar-menu-item').classList.add('active');
                }
            }
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', updateNavbarActive);
        
        // Update after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'main-content') {
                const page = evt.detail.xhr.getResponseHeader('X-Page-Name');
                if (page) {
                    document.getElementById('main-content').dataset.page = page;
                }
                updateNavbarActive();
            }
        });

    </script>
    {% endblock %}
</body>
<footer>
    <p>&copy; 2025 Shuttrly. All rights reserved.</p>
</footer>
{% block extra_js %}
{% endblock %}
</html>