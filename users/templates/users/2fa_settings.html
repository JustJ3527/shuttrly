{% extends "base.html" %}

{% load static %}
{% load users_filters datetime_tags %}

{% block title %}Two-Factor Authentication (2FA) Settings{% endblock %}

{% block content %}
<h2>Two-Factor Authentication (2FA)</h2>

{# Display any error messages #}
{% if error %}
  <div style="color: red; margin-bottom: 1em;">{{ error }}</div>
{% endif %}

{# Display Django messages (success, info, warning, etc.) #}
{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<!-- ================== EMAIL 2FA SECTION ================== -->
<div style="margin-bottom: 2em;">
  <h3>üîê By Email:</h3>

  {% if email_2fa_enabled %}
    <p>Email-based 2FA is enabled.</p>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="disable_email">
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Disable</button>
    </form>

  {% elif step == "verify_email_code" %}
    <p>A code has been sent to your email address. Please enter it below.</p>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="verify_email_code" />
      <input type="text" name="email_code" placeholder="Enter the received code" required />
      <button type="submit">Verify</button>
    </form>

    <form method="POST" style="display: inline;">
      {% csrf_token %}
      <button type="submit" name="action" value="cancel">Cancel</button>
    </form>

    <div class="countdown" id="countdown">
      {% if not can_resend %}
        You can request a new code in <span id="timer">{{ time_until_resend }}</span> seconds.
      {% endif %}
    </div>

    <form method="POST" id="resend-form" {% if not can_resend %}style="display:none;"{% endif %}>
      {% csrf_token %}
      <input type="hidden" name="action" value="resend_email_code" />
      <button type="submit">Resend Code</button>
    </form>

  {% else %}
    <p>Email-based 2FA is disabled.</p>
    <form method="POST">
      {% csrf_token %}
      <input type="password" name="password" placeholder="Password" required>
      <input type="hidden" name="action" value="enable_email">
      <button type="submit">Enable</button>
    </form>
  {% endif %}
</div>

<!-- ================== TOTP 2FA SECTION ================== -->
<div>
  <h3>üì± Authentication App (TOTP):</h3>

  {% if totp_enabled %}
    <p>TOTP-based 2FA is enabled.</p>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="disable_totp">
      <input type="password" name="password" placeholder="Password" required>
      <input type="text" name="disable_totp_code" placeholder="TOTP Code" required>
      <button type="submit">Disable</button>
    </form>

  {% elif step == "verify_totp" %}
    <h2>Set Up Your Authentication App</h2>
    <p>Scan this QR code with an app like Google Authenticator, Authy, or 2FAS:</p>

    <img src="data:image/png;base64,{{ qr_code_url }}" alt="TOTP QR Code" style="max-width: 200px;">

    {% if totp_uri %}
      <div>
        <button id="copyTotpUriBtn" type="button">Copy TOTP URI</button>
        <input type="text" id="totpUriInput" value="{{ totp_uri }}" readonly style="position: absolute; left: -9999px;"/>
        <span id="copyMessage" style="color: green; display: none;">Link copied!</span>
      </div>
    {% endif %}

    <form method="POST">
      {% csrf_token %}
      <input type="text" name="totp_code" placeholder="6-digit code" required>
      <button type="submit" name="action" value="verify_totp">Verify</button>
    </form>

    <form method="POST" style="margin-top: 1em;">
      {% csrf_token %}
      <button type="submit" name="action" value="cancel">Cancel</button>
    </form>

  {% else %}
    <p>TOTP-based 2FA is disabled.</p>
    <form method="POST">
      {% csrf_token %}
      <input type="hidden" name="action" value="enable_totp">
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">Enable</button>
    </form>
  {% endif %}
</div>

<h2>Trusted Devices</h2>

{% if trusted_devices %}
  <div>
    {% for device in trusted_devices %}
      <div class="device">
        <div class="device-summary" onclick="toggleDetails(this)">
          {{ device.device_type|default:"Unknown Device" }}
          {% if device.expires_soon %}
            <span style="color: orange; font-weight: bold; margin-left: 1em;">(Expiring soon)</span>
          {% endif %}
          {% if device.is_current_device %}
            <span class="device-current">(current device)</span>
          {% endif %}
          <br>
          <small>{{ device.location_display|format_location }} ‚Ä¢ on {% local_datetime device.last_used_at %}</small>
        </div>
        <div class="device-details">
          <div><strong>Model:</strong> {{ device.device_family|default:"Unknown" }}</div>
          <div><strong>Browser:</strong> {{ device.browser_family|default:"Unknown" }} {{ device.browser_version|default:"" }}</div>
          <div><strong>Operating System:</strong> {{ device.os_family|default:"Unknown" }} {{ device.os_version|default:"" }}</div>
          <div><strong>IP Address:</strong> {{ device.ip_address|default:"Unknown" }}</div>
          {% if device.expires_at %}
            <div><strong>Expires at:</strong> {% local_datetime device.expires_at %}</div>
          {% endif %}
          <form method="POST" style="margin-top: 0.5em;">
            {% csrf_token %}
            <input type="hidden" name="action" value="remove_trusted_device">
            <input type="hidden" name="device_id" value="{{ device.id }}">
            <button type="submit" onclick="return confirm('Revoke this device?');">Revoke</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>No trusted devices registered.</p>
{% endif %}

<style>
  /* Styles for device summary and details toggling */
  .device-summary {
    cursor: pointer;
    font-weight: bold;
    padding: 0.5em;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 1em;
    transition: background-color 0.2s;
  }
  .device-summary:hover {
    background-color: #f0f0f0;
  }
  .device-details {
    display: none;
    padding: 0.5em 1em;
    background-color: #fafafa;
    border-left: 4px solid #999;
    margin-top: 0.5em;
    font-size: 0.95em;
  }
  .device-current {
    color: green;
    font-weight: bold;
    margin-left: 0.5em;
  }
</style>
{% endblock %}

{% block scripts %}
  {{ block.super }}

  {# Countdown timer for resend email code #}
  {% if not can_resend and time_until_resend > 0 %}
    <div class="countdown" id="countdown" data-countdown-type="email" data-time-until-resend="{{ time_until_resend }}" data-can-resend="{{ can_resend|yesno:'true,false' }}">
      You can request a new code in <span id="timer">{{ time_until_resend }}</span> seconds.
    </div>
  {% endif %}
{% endblock %}