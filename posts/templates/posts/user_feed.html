{% extends 'base.html' %}
{% load static %}

{% block title %}My Feed{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}">
{% endblock %}

{% block content %}
<div class="posts-container">
    <!-- Header -->
    <div class="posts-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col">
                    <h1><i class="fas fa-rss"></i> My Feed</h1>
                    <p class="subtitle">Discover posts from people you follow and trending content</p>
                </div>
                <div class="col-auto">
                    <div class="posts-actions">
                        <a href="{% url 'posts:post_create' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Post
                        </a>
                        <a href="{% url 'posts:post_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-globe"></i> Explore All
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid">
        <div class="row">
            <!-- Main Feed -->
            <div class="col-lg-8">
                <div class="posts-content">
                    <!-- Feed Controls -->
                    <div class="feed-controls mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h5 class="mb-0"><i class="fas fa-sliders-h"></i> Feed Preferences</h5>
                                    </div>
                                    <div class="col-auto">
                                        <div class="feed-options">
                                            <select class="form-select" id="feed-sort">
                                                <option value="recent">Most Recent</option>
                                                <option value="popular">Most Popular</option>
                                                <option value="trending">Trending</option>
                                                <option value="following">Following Only</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feed Content -->
                    <div class="feed-content">
                        {% if posts %}
                            <div class="posts-stream" id="posts-container">
                                {% include 'posts/partials/_user_feed_posts.html' %}
                            </div>

                            <!-- Loading Indicator -->
                            <div class="loading-indicator text-center py-4" id="loading-indicator" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading more posts...</p>
                            </div>

                            <!-- End of Posts -->
                            <div class="end-of-posts text-center py-4" id="end-of-posts" style="display: none;">
                                <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                                <h5>You've reached the end!</h5>
                                <p class="text-muted">No more posts to load.</p>
                            </div>

                            <!-- Load More Button (Fallback) -->
                            {% if has_next %}
                            <div class="load-more-wrapper text-center">
                                <button class="btn btn-outline-primary btn-lg" id="load-more-btn" onclick="loadMorePosts()">
                                    <i class="fas fa-spinner fa-spin" id="load-more-spinner" style="display: none;"></i>
                                    Load More Posts
                                </button>
                            </div>
                            {% endif %}

                        {% else %}
                            <!-- Empty Feed -->
                            <div class="empty-feed">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-rss fa-3x text-muted mb-3"></i>
                                        <h5>Your feed is empty</h5>
                                        <p class="text-muted">
                                            Start following people to see their posts in your feed, or explore trending content.
                                        </p>
                                        <div class="empty-feed-actions">
                                            <a href="{% url 'posts:post_list' %}" class="btn btn-primary">
                                                <i class="fas fa-compass"></i> Explore Posts
                                            </a>
                                            <a href="#" class="btn btn-outline-primary">
                                                <i class="fas fa-user-plus"></i> Find People to Follow
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="posts-sidebar">
                    <!-- Trending Hashtags -->
                    <div class="trending-hashtags mb-4">
                        <h5><i class="fas fa-fire"></i> Trending Hashtags</h5>
                        <div class="hashtags-list">
                            {% for hashtag in trending_hashtags %}
                            <a href="{% url 'posts:hashtag_posts' hashtag.hashtag %}" class="hashtag-item">
                                <span class="hashtag-name">#{{ hashtag.hashtag }}</span>
                                <span class="hashtag-count">{{ hashtag.count }} posts</span>
                            </a>
                            {% empty %}
                            <p class="text-muted small">No trending hashtags yet</p>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Suggested Users -->
                    <div class="suggested-users mb-4">
                        <h5><i class="fas fa-users"></i> Suggested Users</h5>
                        <div class="users-list">
                            <!-- Placeholder for suggested users -->
                            <div class="user-suggestion">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-info">
                                    <strong>username</strong>
                                    <small class="text-muted">@username</small>
                                </div>
                                <button class="btn btn-sm btn-outline-primary">Follow</button>
                            </div>
                        </div>
                    </div>

                    <!-- Feed Stats -->
                    <div class="feed-stats">
                        <h5><i class="fas fa-chart-line"></i> Your Activity</h5>
                        <div class="stats-summary">
                            <div class="stat-row">
                                <span class="stat-label">Posts Created</span>
                                <span class="stat-value">{{ user_posts_count|default:0 }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Posts Liked</span>
                                <span class="stat-value">{{ user_likes_count|default:0 }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Comments Made</span>
                                <span class="stat-value">{{ user_comments_count|default:0 }}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Posts Saved</span>
                                <span class="stat-value">{{ user_saves_count|default:0 }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Viewer Modal -->
<div class="modal fade" id="imageViewerModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageViewerTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" alt="" id="modalImage" class="img-fluid">
            </div>
        </div>
    </div>
</div>

<!-- Include the shared posts SCSS file -->
<link rel="stylesheet" href="{% static 'scss/_posts.scss' %}">

<!-- JavaScript for interactions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Feed sort functionality
    const feedSort = document.getElementById('feed-sort');
    if (feedSort) {
        feedSort.addEventListener('change', function() {
            const sortValue = this.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('sort', sortValue);
            window.location.href = currentUrl.toString();
        });
    }
});

// Image viewer functionality
function openImageViewer(imageSrc, imageTitle) {
    const modal = document.getElementById('imageViewerModal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageViewerTitle');
    
    modalImage.src = imageSrc;
    modalTitle.textContent = imageTitle;
    
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

// Infinite Scroll Configuration
const INFINITE_SCROLL_CONFIG = {
    threshold: 0.1, // Trigger when 10% of the sentinel is visible
    rootMargin: '100px', // Start loading 100px before reaching the bottom
    pageSize: 12, // Number of posts per page
    currentPage: {{ current_page|default:1 }},
    totalPages: {{ total_pages|default:1 }},
    hasNext: {{ has_next|yesno:"true,false" }},
    isLoading: false,
    searchParams: new URLSearchParams(window.location.search)
};

// Initialize infinite scroll when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeInfiniteScroll();
});

// Initialize infinite scroll functionality
function initializeInfiniteScroll() {
    if (!INFINITE_SCROLL_CONFIG.hasNext) {
        showEndOfPosts();
        return;
    }
    
    // Create intersection observer for infinite scroll
    const sentinel = createSentinelElement();
    const observer = new IntersectionObserver(handleIntersection, {
        threshold: INFINITE_SCROLL_CONFIG.threshold,
        rootMargin: INFINITE_SCROLL_CONFIG.rootMargin
    });
    
    observer.observe(sentinel);
}

// Create sentinel element for intersection observer
function createSentinelElement() {
    const sentinel = document.createElement('div');
    sentinel.id = 'infinite-scroll-sentinel';
    sentinel.style.height = '20px';
    sentinel.style.width = '100%';
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.appendChild(sentinel);
    
    return sentinel;
}

// Handle intersection with sentinel element
async function handleIntersection(entries) {
    const entry = entries[0];
    
    if (entry.isIntersecting && !INFINITE_SCROLL_CONFIG.isLoading && INFINITE_SCROLL_CONFIG.hasNext) {
        await loadMorePosts();
    }
}

// Load more posts via AJAX
async function loadMorePosts() {
    if (INFINITE_SCROLL_CONFIG.isLoading || !INFINITE_SCROLL_CONFIG.hasNext) {
        return;
    }
    
    try {
        INFINITE_SCROLL_CONFIG.isLoading = true;
        showLoadingIndicator();
        
        // Calculate next page
        const nextPage = INFINITE_SCROLL_CONFIG.currentPage + 1;
        
        // Build URL with current search parameters
        const url = new URL(window.location);
        url.searchParams.set('page', nextPage);
        
        // Add AJAX header
        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };
        
        // Make AJAX request
        const response = await fetch(url.toString(), { headers });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const html = await response.text();
        
        // Parse response and extract posts
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newPosts = doc.querySelectorAll('.post-item');
        
        if (newPosts.length > 0) {
            // Add new posts to container
            const postsContainer = document.getElementById('posts-container');
            const sentinel = document.getElementById('infinite-scroll-sentinel');
            
            newPosts.forEach(post => {
                postsContainer.insertBefore(post, sentinel);
            });
            
            // Update configuration
            INFINITE_SCROLL_CONFIG.currentPage = nextPage;
            INFINITE_SCROLL_CONFIG.hasNext = newPosts.length === INFINITE_SCROLL_CONFIG.pageSize;
            
            // Update URL without page reload
            window.history.replaceState({}, '', url.toString());
            
        } else {
            INFINITE_SCROLL_CONFIG.hasNext = false;
        }
        
        // Check if we've reached the end
        if (!INFINITE_SCROLL_CONFIG.hasNext) {
            showEndOfPosts();
        }
        
    } catch (error) {
        console.error('Error loading more posts:', error);
        showError('Failed to load more posts. Please try again.');
    } finally {
        INFINITE_SCROLL_CONFIG.isLoading = false;
        hideLoadingIndicator();
    }
}

// Show loading indicator
function showLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'block';
    }
}

// Hide loading indicator
function hideLoadingIndicator() {
    const indicator = document.getElementById('loading-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Show end of posts message
function showEndOfPosts() {
    const endMessage = document.getElementById('end-of-posts');
    if (endMessage) {
        endMessage.style.display = 'block';
    }
}

// Show error message
function showError(message) {
    // Create temporary error notification
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const postsContainer = document.getElementById('posts-container');
    postsContainer.insertBefore(errorDiv, postsContainer.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 5000);
}

// Load more functionality (Fallback button)
function loadMorePosts() {
    const loadMoreBtn = document.getElementById('load-more-btn');
    const spinner = document.getElementById('load-more-spinner');
    
    // Show loading state
    loadMoreBtn.disabled = true;
    spinner.style.display = 'inline-block';
    loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    
    // Simulate loading
    setTimeout(() => {
        // Reset button state
        loadMoreBtn.disabled = false;
        spinner.style.display = 'none';
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin" id="load-more-spinner" style="display: none;"></i> Load More Posts';
        
        // Implementation for loading more posts
        console.log('Load more posts');
    }, 2000);
}
</script>
{% endblock %}
