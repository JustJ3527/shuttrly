{% load users_filters datetime_tags %}

<!-- Advanced Security Category -->
<div class="category-content">
    <!-- Header -->
    <div class="category-header">
        <h2><i class="fas fa-lock"></i> Advanced Security</h2>
        <p class="text-muted">Monitor and manage your account security in detail</p>
    </div>

    <!-- Security Overview Section -->
    <div class="form-section">
        <h3><i class="fas fa-shield-alt"></i> Security Overview</h3>
        
        <div class="security-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-shield-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{% if user.email_2fa_enabled or user.totp_enabled %}2{% else %}0{% endif %}</div>
                    <div class="stat-label">2FA Methods Active</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-desktop"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ trusted_devices.count|default:0 }}</div>
                    <div class="stat-label">Trusted Devices</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ user.last_login_date|date:"M j"|default:"Never" }}</div>
                    <div class="stat-label">Last Login</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-eye-slash"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{% if user.is_private %}Private{% else %}Public{% endif %}</div>
                    <div class="stat-label">Account Privacy</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Sessions Section -->
    <div class="form-section">
        <h3><i class="fas fa-desktop"></i> Active Sessions</h3>
        <p class="text-muted">Manage your currently active login sessions across different devices</p>
        
        {% if trusted_devices %}
            <div class="sessions-list">
                {% for device in trusted_devices %}
                    <div class="session-card {% if device.is_current_device %}current-session{% endif %}">
                        <div class="session-header">
                            <div class="session-info">
                                <div class="device-icon">
                                    <i class="fas fa-{{ device.device_type|lower|default:'desktop' }}"></i>
                                </div>
                                <div class="device-details">
                                    <div class="device-name">
                                        {{ device.device_type|default:"Unknown Device" }}
                                        {% if device.is_current_device %}
                                            <span class="current-badge">Current Session</span>
                                        {% endif %}
                                    </div>
                                    <div class="device-location">
                                        <i class="fas fa-map-marker-alt"></i>
                                        {{ device.location_display|format_location|default:"Unknown Location" }}
                                    </div>
                                </div>
                            </div>
                            <div class="session-actions">
                                {% if device.expires_soon %}
                                    <span class="expiry-warning">Expires soon</span>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-info" onclick="toggleSessionDetails(this)">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                            </div>
                        </div>
                        
                        <div class="session-details" style="display: none;">
                            <div class="details-grid">
                                <div class="detail-item">
                                    <strong>Device Family:</strong> {{ device.device_family|default:"Unknown" }}
                                </div>
                                <div class="detail-item">
                                    <strong>Browser:</strong> {{ device.browser_family|default:"Unknown" }} {{ device.browser_version|default:"" }}
                                </div>
                                <div class="detail-item">
                                    <strong>Operating System:</strong> {{ device.os_family|default:"Unknown" }} {{ device.os_version|default:"" }}
                                </div>
                                <div class="detail-item">
                                    <strong>IP Address:</strong> {{ device.ip_address|default:"Unknown" }}
                                </div>
                                <div class="detail-item">
                                    <strong>Last Used:</strong> {% local_datetime device.last_used_at %}
                                </div>
                                {% if device.expires_at %}
                                    <div class="detail-item">
                                        <strong>Expires:</strong> {% local_datetime device.expires_at %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="session-actions-bottom">
                                {% if not device.is_current_device %}
                                    <form method="POST" style="display: inline;" 
                                          hx-post="{% url 'settings_save' 'security' %}" 
                                          hx-target="#settings-content-area" 
                                          hx-swap="innerHTML">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="remove_trusted_device">
                                        <input type="hidden" name="device_id" value="{{ device.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                onclick="return confirm('Are you sure you want to revoke access for this device?')">
                                            <i class="fas fa-trash"></i> Revoke Access
                                        </button>
                                    </form>
                                {% else %}
                                    <span class="text-muted">
                                        <i class="fas fa-info-circle"></i> 
                                        This is your current session. You cannot revoke it while using it.
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-sessions">
                <div class="alert alert-light text-center">
                    <i class="fas fa-info-circle" style="font-size: 3rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p><strong>No active sessions found</strong></p>
                    <p class="text-muted">When you log in from new devices, they will appear here</p>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Security Recommendations Section -->
    <div class="form-section">
        <h3><i class="fas fa-lightbulb"></i> Security Recommendations</h3>
        
        <div class="recommendations-list">
            {% if not user.email_2fa_enabled and not user.totp_enabled %}
                <div class="recommendation-item warning">
                    <div class="recommendation-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Enable Two-Factor Authentication</h4>
                        <p>Your account is not protected by 2FA. Enable it to add an extra layer of security.</p>
                        <a href="#" onclick="loadCategory('security')" class="btn btn-sm btn-warning">
                            <i class="fas fa-shield-alt"></i> Enable 2FA
                        </a>
                    </div>
                </div>
            {% endif %}
            
            {% if trusted_devices.count > 3 %}
                <div class="recommendation-item info">
                    <div class="recommendation-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Review Trusted Devices</h4>
                        <p>You have many trusted devices. Consider reviewing and removing unused ones.</p>
                    </div>
                </div>
            {% endif %}
            
            {% if user.is_private == False %}
                <div class="recommendation-item info">
                    <div class="recommendation-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="recommendation-content">
                        <h4>Consider Private Account</h4>
                        <p>Your account is currently public. Consider making it private for enhanced privacy.</p>
                        <a href="#" onclick="loadCategory('security')" class="btn btn-sm btn-info">
                            <i class="fas fa-eye-slash"></i> Make Private
                        </a>
                    </div>
                </div>
            {% endif %}
            
            <div class="recommendation-item success">
                <div class="recommendation-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="recommendation-content">
                    <h4>Strong Password</h4>
                    <p>Make sure you're using a strong, unique password for your account.</p>
                    <a href="#" onclick="loadCategory('general')" class="btn btn-sm btn-success">
                        <i class="fas fa-key"></i> Change Password
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Log Section -->
    <div class="form-section">
        <h3><i class="fas fa-history"></i> Recent Security Activity</h3>
        <p class="text-muted">Monitor recent security-related activities on your account</p>
        
        <div class="security-log">
            <div class="log-entry">
                <div class="log-icon">
                    <i class="fas fa-sign-in-alt"></i>
                </div>
                <div class="log-content">
                    <div class="log-title">Last Login</div>
                    <div class="log-details">
                        {% if user.last_login_date %}
                            {{ user.last_login_date|date:"F j, Y \a\t g:i A" }}
                            {% if user.last_login_ip %}
                                from {{ user.last_login_ip }}
                            {% endif %}
                        {% else %}
                            Never logged in
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="log-entry">
                <div class="log-icon">
                    <i class="fas fa-user-edit"></i>
                </div>
                <div class="log-content">
                    <div class="log-title">Profile Last Updated</div>
                    <div class="log-details">
                        {% if user.date_joined %}
                            {{ user.date_joined|date:"F j, Y \a\t g:i A" }}
                        {% else %}
                            Unknown
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="log-entry">
                <div class="log-icon">
                    <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="log-content">
                    <div class="log-title">Account Created</div>
                    <div class="log-details">
                        {{ user.date_joined|date:"F j, Y" }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleSessionDetails(button) {
        const details = button.closest('.session-card').querySelector('.session-details');
        const icon = button.querySelector('i');
        
        if (details.style.display === 'none' || !details.style.display) {
            details.style.display = 'block';
            icon.classList.remove('fa-info-circle');
            icon.classList.add('fa-times');
            button.innerHTML = '<i class="fas fa-times"></i> Hide';
        } else {
            details.style.display = 'none';
            icon.classList.remove('fa-times');
            icon.classList.add('fa-info-circle');
            button.innerHTML = '<i class="fas fa-info-circle"></i> Details';
        }
    }
    
    function loadCategory(category) {
        // Use HTMX to load the specified category
        const url = `${window.settingsBaseUrl}${category}/`;
        htmx.ajax('GET', url, '#settings-content-area');
    }
</script>

<style>
    .security-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .stat-card {
        background: #fff;
        padding: 1.5rem;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        border-color: #28a745;
    }
    
    .stat-icon {
        font-size: 2rem;
        color: #28a745;
        margin-bottom: 1rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .sessions-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .session-card {
        background: #fff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .session-card:hover {
        border-color: #28a745;
        box-shadow: 0 4px 16px rgba(40, 167, 69, 0.1);
    }
    
    .session-card.current-session {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.05);
    }
    
    .session-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
    }
    
    .session-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .device-icon {
        width: 48px;
        height: 48px;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #28a745;
        font-size: 1.25rem;
    }
    
    .device-name {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .current-badge {
        background: #28a745;
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-left: 0.5rem;
    }
    
    .device-location {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .device-location i {
        margin-right: 0.25rem;
    }
    
    .session-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .expiry-warning {
        color: #fd7e14;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .session-details {
        padding: 1rem;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .detail-item {
        font-size: 0.9rem;
        color: #495057;
    }
    
    .detail-item strong {
        color: #28a745;
    }
    
    .session-actions-bottom {
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
        text-align: right;
    }
    
    .no-sessions {
        text-align: center;
        padding: 2rem;
    }
    
    .recommendations-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .recommendation-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1.25rem;
        border-radius: 8px;
        border-left: 4px solid;
    }
    
    .recommendation-item.warning {
        background: rgba(255, 193, 7, 0.1);
        border-left-color: #ffc107;
    }
    
    .recommendation-item.info {
        background: rgba(23, 162, 184, 0.1);
        border-left-color: #17a2b8;
    }
    
    .recommendation-item.success {
        background: rgba(40, 167, 69, 0.1);
        border-left-color: #28a745;
    }
    
    .recommendation-icon {
        font-size: 1.5rem;
        margin-top: 0.25rem;
    }
    
    .recommendation-item.warning .recommendation-icon {
        color: #ffc107;
    }
    
    .recommendation-item.info .recommendation-icon {
        color: #17a2b8;
    }
    
    .recommendation-item.success .recommendation-icon {
        color: #28a745;
    }
    
    .recommendation-content h4 {
        margin: 0 0 0.5rem 0;
        color: #495057;
        font-size: 1.1rem;
    }
    
    .recommendation-content p {
        margin: 0 0 1rem 0;
        color: #6c757d;
        line-height: 1.4;
    }
    
    .security-log {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .log-entry {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .log-icon {
        width: 40px;
        height: 40px;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #28a745;
        font-size: 1rem;
    }
    
    .log-content {
        flex: 1;
    }
    
    .log-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
    }
    
    .log-details {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
        .security-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .session-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .session-actions {
            width: 100%;
            justify-content: space-between;
        }
        
        .details-grid {
            grid-template-columns: 1fr;
        }
        
        .recommendation-item {
            flex-direction: column;
            text-align: center;
        }
    }
</style>
