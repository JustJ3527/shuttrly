{% extends 'base.html' %}
{% load static %}
{% block title %}Register - Shuttrly{% endblock %}
{% block head %}
    {{ block.super}}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C - Étape {{ step }}/6</title>

    <!--Local CSS files-->
    <link rel="stylesheet" href="{% static 'css/users.css' %}">

{% endblock %}

{% block content %}
    <style>
        .login-container {
            max-width: 450px;
            width: 100%;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 3rem;
            position: relative;
            overflow: hidden;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .login-title {
            color: #2c3e50;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .login-subtitle {
            color: #6c757d;
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
        }
        
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dee2e6;
            transition: all 0.3s ease;
        }
        
        .step-dot.active {
            background: #007bff;
            transform: scale(1.2);
        }
        
        .step-dot.completed {
            background: #28a745;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }
        
        .form-check {
            margin: 1rem 0;
        }
        
        .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .form-check-label {
            color: #495057;
            font-weight: 500;
        }
        
        .btn {
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-outline-secondary {
            border: 2px solid #dee2e6;
            color: #6c757d;
        }
        
        .btn-outline-secondary:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
            color: #495057;
            transform: none;
        }
        
        .verification-code-input {
            font-size: 2rem;
            letter-spacing: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .method-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .method-card:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateY(-1px);
        }
        
        .method-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        }
        
        .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #007bff;
        }
        
        .method-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2c3e50;
        }
        
        .method-description {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0;
        }
        
        .divider {
            text-align: center;
            margin: 2rem 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #dee2e6;
        }
        
        .divider span {
            background: white;
            padding: 0 1rem;
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .alert {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.25rem;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
            color: white;
        }
        
        .alert-info {
            background: linear-gradient(135deg, #17a2b8 0%, #007bff 100%);
            color: white;
        }
        
        .security-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #17a2b8;
        }
        
        .security-info h6 {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .security-info p {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 0;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading .loading-spinner {
            display: inline-block;
        }
        
        .loading .btn-text {
            display: none;
        }
        
        @media (max-width: 576px) {
            .login-card {
                padding: 2rem 1.5rem;
                margin: 1rem;
            }
            
            .verification-code-input {
                font-size: 1.5rem;
                letter-spacing: 0.5rem;
            }
        }
    </style>
<div class="container-bc">
  <div class="container-fluid" style="height: 100%;position: absolute;">
    <div class="login-container registration-container">
        <div class="login-card fade-in">
            <div class="login-header">
                {% if step == 'login' %}
                    <h2 class="login-title">
                        <i class="fas fa-sign-in-alt text-primary"></i>
                        Connexion
                    </h2>
                    <p class="login-subtitle">Connectez-vous à votre compte</p>
                {% elif step == 'choose_2fa' %}
                    <h2 class="login-title">
                        <i class="fas fa-shield-alt text-primary"></i>
                        Vérification en deux étapes
                    </h2>
                    <p class="login-subtitle">Choisissez votre méthode de vérification</p>
                {% elif step == 'email_2fa' %}
                    <h2 class="login-title">
                        <i class="fas fa-envelope text-primary"></i>
                        Code par email
                    </h2>
                    <p class="login-subtitle">Vérifiez votre boîte mail</p>
                {% elif step == 'totp_2fa' %}
                    <h2 class="login-title">
                        <i class="fas fa-mobile-alt text-primary"></i>
                        Authentificateur
                    </h2>
                    <p class="login-subtitle">Code de votre application</p>
                {% endif %}
            </div>

            <!-- Indicateur d'étapes pour 2FA -->
            {% if step != 'login' %}
            <div class="step-indicator">
                <div class="step-dot completed"></div>
                <div class="step-dot {% if step == 'choose_2fa' %}active{% elif step in 'email_2fa,totp_2fa' %}completed{% endif %}"></div>
                <div class="step-dot {% if step in 'email_2fa,totp_2fa' %}active{% endif %}"></div>
            </div>
            {% endif %}

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="fas {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-triangle{% elif message.tags == 'warning' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
                        {{ message|safe }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <form method="POST" id="login-form">
                {% csrf_token %}
                <input type="hidden" name="step" value="{{ step }}">

                {% if step == 'login' %}
                    <!-- Étape 1: Connexion classique -->
                    <div class="mb-3">
                        <label for="id_email" class="form-label">Email ou nom d'utilisateur</label>
                        <input type="text" class="form-control" id="id_email" name="email" 
                               placeholder="votre@email.com ou nom_utilisateur" 
                               autocomplete="username" required>
                        <small class="form-text text-muted">Vous pouvez utiliser votre email ou votre nom d'utilisateur</small>
                    </div>

                    <div class="mb-3">
                        <label for="id_password" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="id_password" name="password" 
                               placeholder="Votre mot de passe" 
                               autocomplete="current-password" required>
                    </div>

                    <div class="form-check mb-4">
                        <input type="checkbox" class="form-check-input" id="id_remember_device" name="remember_device">
                        <label class="form-check-label" for="id_remember_device">
                            Se souvenir de moi
                        </label>
                        <small class="form-text text-muted d-block">Garder ma session active plus longtemps</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <span class="btn-text">
                            <i class="fas fa-sign-in-alt"></i> Se connecter
                        </span>
                        <span class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Connexion...
                        </span>
                    </button>

                    <div class="divider">
                        <span>ou</span>
                    </div>

                    <div class="text-center">
                        <p class="text-muted mb-2">Pas encore de compte ?</p>
                        <a href="{% url 'register' %}" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-user-plus"></i> Créer un compte
                        </a>
                    </div>

                    <div class="text-center mt-3">
                        <a href="#" class="text-muted text-decoration-none">
                            <i class="fas fa-key"></i> Mot de passe oublié ?
                        </a>
                    </div>

                {% elif step == 'choose_2fa' %}
                    <!-- Étape 2: Choix de la méthode 2FA -->
                    <div class="security-info">
                        <h6><i class="fas fa-shield-alt"></i> Sécurité renforcée</h6>
                        <p>Votre compte est protégé par une vérification en deux étapes. Choisissez votre méthode préférée.</p>
                    </div>

                    <div class="mb-4">
                        {% if user.email_2fa_enabled %}
                        <div class="method-card" data-method="email">
                            <div class="form-check">
                                <input type="hidden" name="remember_device" value="{{ remember_device }}">
                                <input class="form-check-input" type="radio" name="twofa_method" value="email" id="method_email" required>
                                <label class="form-check-label w-100" for="method_email">
                                    <div class="d-flex align-items-center">
                                        <div class="method-icon me-3">
                                            <i class="fas fa-envelope"></i>
                                        </div>
                                        <div>
                                            <div class="method-title">Code par email</div>
                                            <div class="method-description">Recevez un code à {{ user.email }}</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endif %}

                        {% if user.totp_enabled %}
                        <div class="method-card" data-method="totp">
                            <div class="form-check">
                                <input type="hidden" name="remember_device" value="{{ remember_device }}">
                                <input class="form-check-input" type="radio" name="twofa_method" value="totp" id="method_totp" required>
                                <label class="form-check-label w-100" for="method_totp">
                                    <div class="d-flex align-items-center">
                                        <div class="method-icon me-3">
                                            <i class="fas fa-mobile-alt"></i>
                                        </div>
                                        <div>
                                            <div class="method-title">Application d'authentification</div>
                                            <div class="method-description">Google Authenticator, Authy, etc.</div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <span class="btn-text">
                            <i class="fas fa-arrow-right"></i> Continuer
                        </span>
                        <span class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Envoi...
                        </span>
                    </button>

                {% elif step == 'email_2fa' %}
                    <!-- Étape 3a: Code par email -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        Un code de vérification a été envoyé à <strong>{{ user.email }}</strong>
                    </div>

                    <div class="mb-4">
                        <label for="id_twofa_code" class="form-label">Code de vérification</label>
                        <input type="hidden" name="remember_device" value="{{ remember_device }}">
                        <input type="text" class="form-control verification-code-input" 
                               id="id_twofa_code" name="twofa_code" 
                               maxlength="6" pattern="[0-9]{6}" 
                               placeholder="000000" 
                               autocomplete="one-time-code" required>
                        <small class="form-text text-muted">Entrez le code reçu par email</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <span class="btn-text">
                            <i class="fas fa-check"></i> Vérifier le code
                        </span>
                        <span class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Vérification...
                        </span>
                    </button>

                    <div class="text-center">
                        <button type="button" class="btn btn-link" onclick="resendEmailCode()">
                            <i class="fas fa-redo"></i> Renvoyer le code
                        </button>
                    </div>

                {% elif step == 'totp_2fa' %}
                    <!-- Étape 3b: Code TOTP -->
                    <div class="security-info">
                        <h6><i class="fas fa-mobile-alt"></i> Application d'authentification</h6>
                        <p>Ouvrez votre application d'authentification (Google Authenticator, Authy, etc.) et entrez le code à 6 chiffres.</p>
                    </div>

                    <div class="mb-4">
                        <label for="id_twofa_code" class="form-label">Code d'authentification</label>
                        <input type="hidden" name="remember_device" value="{{ remember_device }}">
                        <input type="text" class="form-control verification-code-input" 
                               id="id_twofa_code" name="twofa_code" 
                               maxlength="6" pattern="[0-9]{6}" 
                               placeholder="000000" 
                               autocomplete="one-time-code" required>
                        <small class="form-text text-muted">Code de votre application d'authentification</small>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <span class="btn-text">
                            <i class="fas fa-check"></i> Vérifier le code
                        </span>
                        <span class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Vérification...
                        </span>
                    </button>

                {% endif %}

                <!-- Bouton retour pour les étapes 2FA -->
                {% if step in 'choose_2fa,email_2fa,totp_2fa' %}
                <div class="text-center mt-3">
                    <a href="{% url 'login' %}" class="text-muted text-decoration-none">
                        <i class="fas fa-arrow-left"></i> Retour à la connexion
                    </a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script>
      // Auto-focus du premier champ
      document.addEventListener('DOMContentLoaded', function() {
          const firstInput = document.querySelector('.form-control');
          if (firstInput) {
              firstInput.focus();
          }
      });

      // Gestion des cartes de méthodes 2FA
      {% if step == 'choose_2fa' %}
      document.querySelectorAll('.method-card').forEach(card => {
          const radio = card.querySelector('input[type="radio"]');
          
          card.addEventListener('click', function() {
              // Déselectionner toutes les cartes
              document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
              document.querySelectorAll('input[name="twofa_method"]').forEach(r => r.checked = false);
              
              // Sélectionner la carte cliquée
              this.classList.add('selected');
              radio.checked = true;
          });
          
          // Si déjà sélectionné
          if (radio.checked) {
              card.classList.add('selected');
          }
      });
      {% endif %}

      // Auto-submit pour les codes de vérification
      {% comment %} {% if step in 'email_2fa,totp_2fa' %}
      const codeInput = document.getElementById('id_twofa_code');
      
      codeInput.addEventListener('input', function() {
          // Permettre seulement les chiffres
          this.value = this.value.replace(/[^0-9]/g, '');
          
          // Auto-submit si 6 chiffres
          if (this.value.length === 6) {
              setTimeout(() => {
                  document.getElementById('login-form').submit();
              }, 500);
          }
      });
      {% endif %} {% endcomment %}

      // Animation de chargement sur les boutons
      document.getElementById('login-form').addEventListener('submit', function() {
          const submitBtn = this.querySelector('button[type="submit"]');
          submitBtn.classList.add('loading');
          submitBtn.disabled = true;
          
          // Réactiver après 10 secondes au cas où
          setTimeout(() => {
              submitBtn.classList.remove('loading');
              submitBtn.disabled = false;
          }, 10000);
      });

      // Fonction pour renvoyer le code email
      function resendEmailCode() {
          fetch(window.location.href, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/x-www-form-urlencoded',
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              },
              body: 'step=email_2fa&resend_code=true'
          }).then(() => {
              alert('Code renvoyé !');
          }).catch(() => {
              alert('Erreur lors du renvoi');
          });
      }

      // Navigation au clavier
      document.addEventListener('keydown', function(e) {
          // Échap pour retourner à la connexion depuis la 2FA
          if (e.key === 'Escape' && '{{ step }}' !== 'login') {
              window.location.href = '{% url "login" %}';
          }
      });

      // Gestion de l'état en ligne/hors ligne
      window.addEventListener('offline', function() {
          const form = document.getElementById('login-form');
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-wifi"></i> Hors ligne';
      });

      window.addEventListener('online', function() {
          const form = document.getElementById('login-form');
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.disabled = false;
          
          // Restaurer le texte original du bouton selon l'étape
          {% if step == 'login' %}
          submitBtn.innerHTML = '<span class="btn-text"><i class="fas fa-sign-in-alt"></i> Se connecter</span><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Connexion...</span>';
          {% elif step == 'choose_2fa' %}
          submitBtn.innerHTML = '<span class="btn-text"><i class="fas fa-arrow-right"></i> Continuer</span><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Envoi...</span>';
          {% elif step in 'email_2fa,totp_2fa' %}
          submitBtn.innerHTML = '<span class="btn-text"><i class="fas fa-check"></i> Vérifier le code</span><span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Vérification...</span>';
          {% endif %}
      });

      // Validation côté client
      document.getElementById('login-form').addEventListener('submit', function(e) {
          {% if step == 'login' %}
          const email = document.getElementById('id_email').value.trim();
          const password = document.getElementById('id_password').value;
          
          if (!email) {
              e.preventDefault();
              alert('Veuillez entrer votre email ou nom d\'utilisateur');
              return;
          }
          
          if (!password) {
              e.preventDefault();
              alert('Veuillez entrer votre mot de passe');
              return;
          }
          {% elif step == 'choose_2fa' %}
          const selectedMethod = document.querySelector('input[name="twofa_method"]:checked');
          if (!selectedMethod) {
              e.preventDefault();
              alert('Veuillez choisir une méthode de vérification');
              return;
          }
          {% elif step in 'email_2fa,totp_2fa' %}
          const code = document.getElementById('id_twofa_code').value.trim();
          if (!code || code.length !== 6) {
              e.preventDefault();
              alert('Veuillez entrer un code à 6 chiffres');
              return;
          }
          {% endif %}
      });

      // Feedback haptique sur mobile (si supporté)
      function vibrate(pattern = [100]) {
          if ('vibrate' in navigator) {
              navigator.vibrate(pattern);
          }
      }

      // Vibration sur les erreurs
      {% if messages %}
      {% for message in messages %}
      {% if message.tags == 'error' %}
      vibrate([100, 50, 100]);
      {% endif %}
      {% endfor %}
      {% endif %}

      // Vibration légère lors de la saisie complète du code
      {% if step in 'email_2fa,totp_2fa' %}
      document.getElementById('id_twofa_code').addEventListener('input', function() {
          if (this.value.length === 6) {
              vibrate([50]);
          }
      });
      {% endif %}

      // Sauvegarde de l'état du formulaire en cas de rechargement
      {% if step == 'login' %}
      const emailInput = document.getElementById('id_email');
      const rememberCheckbox = document.getElementById('id_remember_device');

      // Restaurer les valeurs sauvegardées
      if (localStorage.getItem('login_email')) {
          emailInput.value = localStorage.getItem('login_email');
      }
      if (localStorage.getItem('login_remember') === 'true') {
          rememberCheckbox.checked = true;
      }

      // Sauvegarder les valeurs en temps réel
      emailInput.addEventListener('input', function() {
          localStorage.setItem('login_email', this.value);
      });

      rememberCheckbox.addEventListener('change', function() {
          localStorage.setItem('login_remember', this.checked);
      });

      // Nettoyer après connexion réussie
      document.getElementById('login-form').addEventListener('submit', function() {
          setTimeout(() => {
              localStorage.removeItem('login_email');
              localStorage.removeItem('login_remember');
          }, 1000);
      });
      {% endif %}

      // Gestion des messages toast auto-dismissible
      setTimeout(function() {
          const alerts = document.querySelectorAll('.alert');
          alerts.forEach(alert => {
              if (!alert.classList.contains('alert-warning')) {
                  const closeBtn = alert.querySelector('.btn-close');
                  if (closeBtn) {
                      closeBtn.click();
                  }
              }
          });
      }, 5000);

      // Analytics et tracking (optionnel)
      if (typeof gtag !== 'undefined') {
          gtag('event', 'login_step', {
              'step_name': '{{ step }}',
              'method': '{{ step }}'
          });
      }

      // Log pour débogage
      console.log('Étape de connexion:', '{{ step }}');

      // Protection contre les attaques par force brute (côté client)
      {% if step == 'login' %}
      let loginAttempts = parseInt(localStorage.getItem('login_attempts') || '0');
      const lastAttempt = localStorage.getItem('last_login_attempt');
      
      if (loginAttempts >= 5 && lastAttempt) {
          const timeSinceLastAttempt = Date.now() - parseInt(lastAttempt);
          const waitTime = 300000 - timeSinceLastAttempt; // 5 minutes
          
          if (waitTime > 0) {
              const submitBtn = document.querySelector('button[type="submit"]');
              submitBtn.disabled = true;
              submitBtn.innerHTML = `<i class="fas fa-clock"></i> Attendez ${Math.ceil(waitTime/60000)} min`;
              
              setTimeout(() => {
                  localStorage.removeItem('login_attempts');
                  localStorage.removeItem('last_login_attempt');
                  location.reload();
              }, waitTime);
          }
      }

      // Compter les tentatives échouées
      {% for message in messages %}
      {% if message.tags == 'error' and 'incorrect' in message|lower %}
      loginAttempts++;
      localStorage.setItem('login_attempts', loginAttempts.toString());
      localStorage.setItem('last_login_attempt', Date.now().toString());
      
      if (loginAttempts >= 5) {
          const submitBtn = document.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<i class="fas fa-ban"></i> Trop de tentatives';
      }
      {% endif %}
      {% endfor %}
      {% endif %}

      // Amélioration de l'accessibilité
      document.addEventListener('keydown', function(e) {
          // Tab pour naviguer entre les méthodes 2FA
          {% if step == 'choose_2fa' %}
          if (e.key === 'Tab') {
              const cards = document.querySelectorAll('.method-card');
              const focused = document.activeElement;
              
              cards.forEach(card => {
                  if (card.contains(focused)) {
                      card.classList.add('focused');
                  } else {
                      card.classList.remove('focused');
                  }
              });
          }
          {% endif %}
      });

      // Préchargement des ressources pour l'étape suivante
      {% if step == 'login' %}
      // Précharger les assets pour la 2FA
      const link = document.createElement('link');
      link.rel = 'prefetch';
      link.href = '{% url "login" %}?step=choose_2fa';
      document.head.appendChild(link);
      {% endif %}

      // Indicateur de force de connexion réseau
      if ('connection' in navigator) {
          const connection = navigator.connection;
          if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
              const form = document.getElementById('login-form');
              const warning = document.createElement('div');
              warning.className = 'alert alert-warning mt-3';
              warning.innerHTML = '<i class="fas fa-wifi"></i> Connexion lente détectée. Le processus peut prendre plus de temps.';
              form.appendChild(warning);
          }
      }

  </script>
{% endblock %}