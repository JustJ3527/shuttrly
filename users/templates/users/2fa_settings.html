{% extends "base.html" %}
{% load static %}

{% block title %}Param√®tres 2FA{% endblock %}

{% block content %}
<h2>Authentification √† deux facteurs (2FA)</h2>

{% if error %}
  <div style="color: red; margin-bottom: 1em;">{{ error }}</div>
{% endif %}
{% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<!-- ================== EMAIL 2FA ================== -->
<div style="margin-bottom: 2em;">
  <h3>üîê Par e-mail :</h3>

  {% if email_2fa_enabled %}
    <p>La 2FA par e-mail est activ√©e.</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="disable_email">
      <input type="password" name="password" placeholder="Password" required>
      <button type="submit">D√©sactiver</button>
    </form>
  {% elif step == "verify_email_code" %}
    <p>Un code a √©t√© envoy√© √† votre adresse e-mail. Veuillez le saisir ci-dessous.</p>
        <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="verify_email_code" />
        <input type="text" name="email_code" placeholder="Entrez le code re√ßu" required />

        <button type="submit">V√©rifier</button>
    </form>
    <form method="post" style="display: inline;">
        {% csrf_token %}
      <button type="submit" name="action" value="cancel">Annuler</button>
    </form>

    <div class="countdown" id="countdown">
        {% if not can_resend %}
            Vous pourrez redemander un code dans <span id="timer">{{ time_until_resend }}</span> secondes.
        {% endif %}
    </div>

    <form method="post" id="resend-form" {% if not can_resend %}style="display:none;"{% endif %}>
        {% csrf_token %}
        <input type="hidden" name="action" value="resend_email_code" />
        <button type="submit">Renvoyer un code</button>
    </form>
  {% else %}
    <p>La 2FA par e-mail est d√©sactiv√©e.</p>
    <form method="post">
      {% csrf_token %}
      <input type="password" name="password" placeholder="Password" required>
      <input type="hidden" name="action" value="enable_email">
      <button type="submit">Activer</button>
    </form>
  {% endif %}
</div>

<!-- ================== TOTP 2FA ================== -->
<div>
  <h3>üì± Application d‚Äôauthentification (TOTP) :</h3>

  {% if totp_enabled %}
    <p>La 2FA via application (TOTP) est activ√©e.</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="disable_totp">
      <input type="password" name="password" placeholder="Mot de passe" required>
      <input type="text" name="totp_code" placeholder="Code TOTP" required>
      <button type="submit">D√©sactiver</button>
    </form>
  {% elif step == "verify_totp" %}
        <h2>Configurer votre application d‚Äôauthentification</h2>
        <p>Scannez ce QR code avec une application comme Google Authenticator, Authy ou 2FAS :</p>

        <img src="data:image/png;base64,{{ qr_code_url }}" alt="QR Code TOTP" style="max-width: 200px;">

        {% if totp_uri %}
            <div>
                <button id="copyTotpUriBtn" type="button">Copier le lien TOTP</button>
                <input type="text" id="totpUriInput" value="{{ totp_uri }}" readonly style="position: absolute; left: -9999px;"/>
                <span id="copyMessage" style="color: green; display: none;">Lien copi√© !</span>
            </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}
            <input type="text" name="totp_code" placeholder="Code √† 6 chiffres" required>
            <button type="submit" name="action" value="verify_totp">V√©rifier</button>
        </form>

        <form method="post" style="margin-top: 1em;">
            {% csrf_token %}
            <button type="submit" name="action" value="cancel">Annuler</button>
        </form>
  {% else %}
    <p>La 2FA via application est d√©sactiv√©e.</p>
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="enable_totp">
      <input type="password" name="password" placeholder="Mot de passe" required>
      <button type="submit">Activer</button>
    </form>
  {% endif %}
</div>

<h2>Appareils de confiance</h2>

{% if trusted_devices %}
  <div>
    {% for device in trusted_devices %}
      <div class="device">
        <div class="device-summary" onclick="toggleDetails(this)">
          {{ device.device_type }}
          {% if device.is_current_device %}
            <span class="device-current">(appareil actuel)</span>
          {% endif %}
          <br>
          <small>{{ device.location|default:"Localisation inconnue" }} ‚Ä¢ le {{ device.last_used_at|date:"SHORT_DATETIME_FORMAT" }}</small>
        </div>
        <div class="device-details">
          <div><strong>Mod√®le :</strong> {{ device.device_family }}</div>
          <div><strong>Navigateur :</strong> {{ device.browser_family }} {{ device.browser_version }}</div>
          <div><strong>Syst√®me d‚Äôexploitation :</strong> {{ device.os_family }} {{ device.os_version }}</div>
          <div><strong>Adresse IP :</strong> {{ device.ip_address|default:"Inconnue" }}</div>
          <form method="POST" style="margin-top: 0.5em;">
            {% csrf_token %}
            <input type="hidden" name="action" value="revoke_device">
            <input type="hidden" name="revoke_device_id" value="{{ device.id }}">
            <button type="submit" onclick="return confirm('R√©voquer cet appareil ?');">R√©voquer</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
{% else %}
  <p>Aucun appareil de confiance enregistr√©.</p>
{% endif %}


<style>
.device-summary {
    cursor: pointer;
    font-weight: bold;
    padding: 0.5em;
    border: 1px solid #ccc;
    border-radius: 8px;
    margin-bottom: 1em;
    transition: background-color 0.2s;
}
.device-summary:hover {
    background-color: #f0f0f0;
}
.device-details {
    display: none;
    padding: 0.5em 1em;
    background-color: #fafafa;
    border-left: 4px solid #999;
    margin-top: 0.5em;
    font-size: 0.95em;
}
.device-current {
    color: green;
    font-weight: bold;
    margin-left: 0.5em;
}
</style>


{% endblock %}x

{% block scripts %}
{{ block.super }}
{% if not can_resend and time_until_resend > 0 %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        let timeLeft = {{ time_until_resend }};
        const timerElement = document.getElementById('timer');
        const countdownElement = document.getElementById('countdown');
        const resendForm = document.getElementById('resend-form');

        const updateTimer = () => {
            if (timeLeft <= 0) {
                // Afficher le formulaire de renvoi
                countdownElement.style.display = "none";
                resendForm.style.display = "block";
                return;
            }

            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            if (minutes > 0) {
                timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timerElement.textContent = seconds;
            }

            timeLeft--;
        };

        updateTimer();
        setInterval(updateTimer, 1000);
    });
</script>
{% endif %}
<script>
  function toggleDetails(summary) {
    const details = summary.nextElementSibling;
    if (details.style.display === "none" || !details.style.display) {
        details.style.display = "block";
    } else {
        details.style.display = "none";
    }
}
    document.getElementById('copyTotpUriBtn').addEventListener('click', function() {
    const input = document.getElementById('totpUriInput');
    input.select();
    input.setSelectionRange(0, 99999); // Pour mobiles
    navigator.clipboard.writeText(input.value).then(() => {
      const msg = document.getElementById('copyMessage');
      msg.style.display = 'inline';
      setTimeout(() => { msg.style.display = 'none'; }, 2000);
    }).catch(err => {
      alert('Erreur lors de la copie du lien : ' + err);
    });
  });
</script>
{% endblock %}